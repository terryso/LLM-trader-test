# Story 8.4: 端到端验证与文档更新

Status: ready-for-dev

## Story

As a maintainer of the bot,
I want end-to-end tests and updated docs for the runtime config feature,
so that the behavior is reliable and clearly communicated.

## Acceptance Criteria

1. 在本地或测试环境中完成至少一次端到端验证（E2E），覆盖运行时配置覆盖层 + Telegram `/config` 命令 + 交易主循环：
   - 以纸上交易模式启动 `bot.py`，且已正确配置 Telegram Bot（含管理员 user_id）。
   - 通过 Telegram 对以下 4 个白名单配置项中的至少 2 个执行 `/config set`：
     - `TRADING_BACKEND`
     - `MARKET_DATA_BACKEND`
     - `TRADEBOT_INTERVAL`
     - `TRADEBOT_LLM_TEMPERATURE`
   - 观察下一轮交易循环中实际生效的 backend / interval / temperature 已按最新运行时值工作（例如通过日志与 `ai_decisions.csv` / `portfolio_state.json` 变化加以确认）。
2. 验证重启行为：
   - 在完成上一步 E2E 验证后停止 Bot 进程；
   - 在不修改 `.env` 的前提下重新启动 Bot；
   - 确认新的运行进程中上述配置项均回退到 `.env` / 默认值，而非继续沿用 runtime overrides。
3. 在项目文档中新增一小节，完整说明运行时配置与 `/config` 命令的用法，至少包括：
   - `/config list|get|set` 的基本语义与参数格式；
   - 支持的 4 个配置项及其取值范围 / 合法枚举；
   - 权限与风险提示（仅管理员可调用 `/config set`，命令不会自动写回 `.env`，所有修改仅对当前进程生效）。
4. 所有新增/修改内容通过现有测试与 lint，`./scripts/run_tests.sh` 无回归。

## Tasks / Subtasks

- [ ] Task 1 – 设计端到端验证场景（AC1, AC2）
  - [ ] 1.1 明确实验环境前置条件：paper 模式、Telegram Bot 配置、最小 `.env` 示例。
  - [ ] 1.2 设计至少一个具体 E2E 用例，包含：初始配置 → `/config set` 操作序列 → 预期行为与观测指标。
  - [ ] 1.3 在 Story 或独立 doc 中记录手工执行步骤，便于他人复现。
- [ ] Task 2 – 实现 / 编排 E2E 验证（AC1, AC2）
  - [ ] 2.1 选择合适方式执行 E2E：可为手工步骤清单、辅助脚本（如 `scripts/manual_runtime_config_e2e.py`）、或集成测试用例。
  - [ ] 2.2 在 E2E 中实际调用 `/config set` 修改至少 2 个配置项，并记录关键日志 / CSV 片段，用于验收证据。
  - [ ] 2.3 验证进程重启后配置回退行为，并记录对比前后配置的证据（如日志片段或 `get_effective_*` 输出）。
- [ ] Task 3 – 文档更新（AC3）
  - [ ] 3.1 在 `README.md` / `README_EN.md` 或 `docs/` 下配置说明中新增「Runtime Config & /config 命令」小节。
  - [ ] 3.2 描述 `/config list|get|set` 的使用方式、示例命令以及 4 个配置项的取值范围。
  - [ ] 3.3 补充权限与风险提示，引用 Story 8.3 中关于管理员权限与审计日志的约定。
- [ ] Task 4 – 回归测试与质量检查（AC4）
  - [ ] 4.1 为新增脚本 / 测试补充或更新对应单元/集成测试（如 `tests/test_telegram_config_commands.py` 或新的 E2E 测试文件）。
  - [ ] 4.2 运行 `./scripts/run_tests.sh`，确保全部测试通过。
  - [ ] 4.3 根据需要更新本 Story 文档的 Change Log 与 Dev Agent Record。

## E2E 验证场景（推荐示例）

本小节给出一条可直接执行的手工 E2E 验证流程，对应 AC1 / AC2 中的要求。

### 前置条件（实验环境）

- `.env` 中将 `TRADING_BACKEND` 配置为 `paper`（或保持默认 paper 模式）。
- `.env` 中已正确配置 Telegram：`TELEGRAM_BOT_TOKEN`、`TELEGRAM_CHAT_ID`。
- `.env` 中配置 `TELEGRAM_ADMIN_USER_ID` 为你的 Telegram user_id，用于允许 `/config set`。
- LLM 相关配置（`LLM_API_BASE_URL`、`LLM_API_KEY`、`TRADEBOT_LLM_MODEL` 等）已就绪，便于观察 temperature 变化对请求的影响。

### 步骤 A：基线观测（未设置 runtime overrides）

1. 在项目根目录启动 Bot：`python3 bot.py`。
2. 等待首轮迭代完成，观察控制台日志中：
   - 当前迭代号与时间戳；
   - 末尾的 `Waiting XXXs...` 提示（例如 `Waiting 900s...` 对应 `TRADEBOT_INTERVAL=15m`）。
3. 在 Telegram 中发送：
   - `/config list`，确认 4 个白名单配置项当前值与 `.env` 中配置一致；
   - `/config get TRADEBOT_INTERVAL`、`/config get TRADEBOT_LLM_TEMPERATURE`，记录当前 interval 与 temperature（例如 `15m` 和 `0.3`）。

### 步骤 B：运行时修改 interval 与 LLM temperature

1. 在 Telegram 中以管理员身份依次发送：
   - `/config set TRADEBOT_INTERVAL 1m`
   - `/config set TRADEBOT_LLM_TEMPERATURE 1.2`
2. 使用 `/config get TRADEBOT_INTERVAL`、`/config get TRADEBOT_LLM_TEMPERATURE` 再次确认：
   - 当前值已经变为 `1m` 和 `1.2`，提示信息中显示合法取值范围正确。
3. 观察下一轮及之后的几轮迭代：
   - 控制台日志中的 `Waiting XXXs...` 变为 `Waiting 60s...`（AC1：interval runtime override 已被主循环使用）；
   - 若使用 /status 或 Dashboard 查看 Sortino，比对实现确认其内部使用的 check interval 已从 `CHECK_INTERVAL` 改为 `get_effective_check_interval()`。
4. 打开 `data/ai_messages.csv`，找到最近一次 LLM 请求对应的行，确认：
   - metadata 中的 `temperature` 字段为 `1.2`（AC1：LLM temperature runtime override 已被 `call_deepseek_api` 使用）。

### 步骤 C：验证重启后的配置回退行为

1. 使用 Ctrl+C 停止当前 Bot 进程，不修改 `.env`。
2. 再次执行 `python3 bot.py` 启动 Bot 新进程。
3. 在 Telegram 中发送：
   - `/config list` 或 `/config get TRADEBOT_INTERVAL`、`/config get TRADEBOT_LLM_TEMPERATURE`；
   - 期望看到 interval / temperature 已回退到 `.env` / 默认值（例如重新变回 `15m` 和 `0.3`），而非继续沿用 `1m` / `1.2`（AC2）。
4. 观察新进程的日志：
   - `Waiting XXXs...` 中的秒数与 `.env` 中的 interval 一致；
   - 后续生成的 `data/ai_messages.csv` 记录里，metadata.temperature 与 `.env` 中的 `TRADEBOT_LLM_TEMPERATURE` 一致。

通过上述流程，可以完整验证：

- Telegram `/config set` → `RuntimeOverrides` 层 → `get_effective_*` → 主循环 / LLM 调用 的端到端链路；
- runtime overrides 仅对当前进程生效，重启后配置自然回退到 `.env` / 默认值。

## Dev Notes

### Requirements & Context Summary

- 本 Story 属于 **Epic 8: Telegram 远程运营配置管理（Runtime Config Control）** 的第四个实现 Story，对应 `sprint-status.yaml` 中的 key：`8-4-端到端验证与文档更新`。
- 需求主要来源：
  - `docs/epics.md` 中 **Story 8.4: 端到端验证与文档更新**：
    - 为运行时配置功能提供端到端验证与文档更新，确保行为可靠且对用户清晰可见。
    - 明确要求至少一次端到端验证，以及在 README / 配置文档中新增 `/config` 命令与运行时覆盖层的说明。
    - [Source: docs/epics.md#Story-8.4-端到端验证与文档更新]
  - `docs/epics.md` 中 **Story 8.1 / 8.2 / 8.3**：
    - 8.1 定义 runtime overrides 层及其 API；
    - 8.2 提供 `/config list|get|set` 命令接口；
    - 8.3 实现管理员权限控制与审计日志。
    - 本 Story 8.4 在这些基础能力之上做端到端行为验证与用户文档收敛。
  - `docs/PRD.md` 中 **4.3 LLM 配置与 Prompt 管理** 与 **4.7 Telegram 通知**：
    - 强调通过环境变量与 Telegram 命令配置关键运行参数，并确保运维交互安全可观测。
    - [Source: docs/PRD.md#4-3-LLM-配置与-Prompt-管理]
    - [Source: docs/PRD.md#4-7-Telegram-通知]

### Architecture & Implementation Constraints

- 分层与职责（参考 `docs/architecture/06-project-structure-and-mapping.md`、`07-implementation-patterns.md`）：
  - 配置与运行时覆盖层集中在 `config/`：
    - `config/settings.py` —— 解析 `.env` 与默认值，暴露 `get_effective_*` 系列函数。
    - `config/runtime_overrides.py` —— runtime overrides 容器与 `set_runtime_override` / `validate_override_value` / `get_override_whitelist` 等 API。
  - Telegram 命令与通知集中在 `notifications/`：
    - `notifications/telegram_commands.py` —— `/config` 命令、权限控制与审计日志。
    - `notifications/telegram.py` —— Telegram 消息发送与 handler wiring。
  - 交易主循环入口在 `bot.py`，应通过 `config` 提供的接口读取配置，而非直接访问 `os.environ`。
- E2E 验证与文档更新需遵守：
  - 不在 E2E 或文档中泄露敏感信息（API Key / 私钥等），仅展示高层配置与示例值。
  - 保持 runtime overrides 的优先级语义：`runtime overrides > env > 默认值`，并在 E2E 验证中显式体现该行为。
  - 若新增测试或辅助脚本，放在 `tests/` 或 `scripts/` 目录中，命名与现有模式一致。

### Project Structure Notes

- 预计主要涉及文件：
  - `bot.py` —— 验证运行时配置变更对主循环行为的实际影响（如 interval、backend、LLM temperature）。
  - `config/settings.py` —— 通过 `get_effective_*` 系列函数观测配置变更前后状态。
  - `config/runtime_overrides.py` —— 复用现有 runtime overrides API，无需新增重复逻辑。
  - `notifications/telegram.py` / `notifications/telegram_commands.py` —— 通过 Telegram `/config` 命令驱动运行时配置变更，复用管理员权限与审计机制。
  - `tests/test_telegram_config_commands.py` 及可能新增的 E2E / 集成测试文件 —— 覆盖端到端路径与关键边界场景。
  - `README.md` / `README_EN.md` 或 `docs/` 下的配置说明文档 —— 新增「Runtime Config & `/config` 命令」说明。
- 需继续遵守：
  - Telegram 命令层仅通过 `config` 包暴露的 API 访问配置，不直接访问 `os.environ`。
  - 文档更新应与 `.env.example`、Epics / PRD 描述保持一致，避免出现第三套说明。

### Learnings from Previous Story

- **前一 Story：** `8-3-权限控制与审计日志`（状态：`done`，详见 `docs/sprint-artifacts/8-3-权限控制与审计日志.md`）。
- 可复用能力与约束：
  - `/config set` 已在 `notifications/telegram_commands.py` 中接入 `_check_admin_permission()` 与 `_log_config_audit()`，只允许管理员修改运行时配置，并为每次成功变更写入结构化审计日志。
    - [Source: docs/sprint-artifacts/8-3-权限控制与审计日志.md#Dev-Notes]
  - 8.3 的测试套件系统性覆盖管理员 / 非管理员路径、日志内容与 runtime overrides 集成行为，E2E 验证可在其基础上扩展而非重写。
  - 8.3 的 Senior Developer Review 指出一个仍未完成的低优先级 Action Item：
    - 在 `/help` 输出中将 `/config set KEY VALUE` 描述更新为「仅限管理员使用」，以减少普通用户的认知偏差。
    - [Source: docs/sprint-artifacts/8-3-权限控制与审计日志.md#Action-Items]
- 对本 Story 的启示：
  - 端到端验证必须在「仅管理员可修改、所有变更有审计日志」这一前提下进行，并在 E2E 证据中体现权限与审计效果。
  - 若在本 Story 的实现过程中顺便完成 `/help` 文案更新，应在本 Story 的 Change Log 与 Dev Agent Record 中记录；若未纳入本 Story 范围，则需要在 Epic 8 路线上单独追踪该 Action Item。

### References

- [Source: docs/epics.md#Story-8.4-端到端验证与文档更新]
- [Source: docs/epics.md#Epic-8-Telegram-远程运营配置管理-Runtime-Config-Control]
- [Source: docs/epics.md#Story-8.1-运行时配置覆盖层-runtime-overrides]
- [Source: docs/epics.md#Story-8.2-Telegram-config-命令接口]
- [Source: docs/epics.md#Story-8.3-权限控制与审计日志]
- [Source: docs/PRD.md#4-3-LLM-配置与-Prompt-管理]
- [Source: docs/PRD.md#4-7-Telegram-通知]
- [Source: docs/architecture/06-project-structure-and-mapping.md]
- [Source: docs/architecture/07-implementation-patterns.md]
- [Source: docs/sprint-artifacts/8-2-telegram-config-命令接口.md#Dev-Notes]
- [Source: docs/sprint-artifacts/8-3-权限控制与审计日志.md#Dev-Agent-Record]

## Dev Agent Record

### Context Reference

- docs/sprint-artifacts/8-4-端到端验证与文档更新.context.xml

### Agent Model Used

Cascade

### Debug Log References

### Completion Notes List

### File List
