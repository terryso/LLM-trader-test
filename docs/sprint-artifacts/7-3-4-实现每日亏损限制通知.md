# Story 7.3.4: 实现每日亏损限制通知

Status: review

## Story

As a user,
I want to receive detailed notifications when the daily loss limit is triggered,
so that I understand the risk situation and can take appropriate actions in time.

## Acceptance Criteria

1. **AC1 – 通知内容与格式（与 Epic 7.3 / FR18 对齐）**  
   - 当每日亏损阈值检查逻辑（Story 7.3.3 中的 `check_daily_loss_limit(...)`）在**本自然日内首次**达到阈值并成功激活 Kill-Switch 时：  
     - 系统应构造一条「每日亏损限制已触发」通知消息，并通过 Telegram 发送；  
     - 消息内容至少包含：  
       - 当前当日亏损百分比 `loss_pct`（负值，保留 2 位小数）；  
       - 配置的每日亏损阈值 `DAILY_LOSS_LIMIT_PCT`；  
       - 当日起始权益 `daily_start_equity`；  
       - 当前权益 `current_equity`；  
       - 当前 Kill-Switch 状态（已自动激活）；  
       - 推荐后续操作选项概要（例如：等待次日自动重置、使用 `/reset_daily`、使用 `/resume confirm` 等）。  
   - 通知应使用清晰醒目的格式：  
     - 使用 emoji 提醒风险（如 ⚠️ / 🚨 等）；  
     - 使用 Telegram 支持的 Markdown / MarkdownV2 格式，对关键信息加粗或用代码块包裹；  
     - 中文文案为主，与现有 Kill-Switch 通知风格保持一致。

2. **AC2 – 与风控逻辑的集成边界（与 Story 7.3.3 / Epic 7.2 对齐）**  
   - 通知发送仅依赖于每日亏损阈值检查的结果，不负责重新计算阈值：  
     - `check_daily_loss_limit(...)` 在判定达到阈值并设置 `daily_loss_triggered=True`、调用 `activate_kill_switch(...)` 之后，通过回调或 helper 触发通知；  
     - 同一自然日内，`daily_loss_triggered=True` 后的后续迭代**不得重复**发送每日亏损限制通知。  
   - 通知逻辑不得改变 Kill-Switch 或每日亏损状态语义：  
     - 不得在通知模块中直接修改 `RiskControlState` 字段；  
     - Kill-Switch 的实际激活/解除仍由 `activate_kill_switch` / `deactivate_kill_switch` 负责。  
   - 当 Telegram 未配置（缺失 `TELEGRAM_BOT_TOKEN` 或 `TELEGRAM_CHAT_ID`）时：  
     - 应记录一条 INFO 级别日志说明「由于未配置 Telegram，本次每日亏损限制通知被跳过」；  
     - 不得抛出异常或中断每日亏损阈值检查 / Kill-Switch 激活流程。

3. **AC3 – 错误处理与可观测性（与 FR19–FR21、架构 7.x 对齐）**  
   - 当发送通知请求失败（例如网络超时、Telegram API 返回 4xx/5xx 或 Markdown 解析错误）时：  
     - 应记录 WARNING 或 ERROR 级别日志，包含：HTTP 状态码、错误消息以及本次尝试的核心参数摘要；  
     - 若错误为 Markdown 解析失败，可按现有模式进行一次「降级重试」（移除 Markdown 格式，仅发送纯文本）；  
     - 在所有错误场景下，都不得影响本地风控逻辑与 Kill-Switch 状态（即每日亏损限制触发仍然生效）。  
   - 日志与通知行为应遵循 `docs/architecture/07-implementation-patterns.md` 中的数据与日志模式：  
     - 使用 UTC 时间；  
     - 避免在正常路径中产生过多噪声日志，仅在触发或异常时记录关键信息。

4. **AC4 – 单元与集成测试覆盖（与 Epic 7.1/7.2/7.3 测试策略对齐）**  
   - 在 `tests/test_notifications_telegram.py` 或等价文件中新增测试用例，至少覆盖：  
     - `build_daily_loss_limit_triggered_message(...)` 生成的文案中包含 AC1 要求的各个字段，并且在典型数值场景下格式正确（包括百分比与金额格式）；  
     - `notify_daily_loss_limit_triggered(...)` 在 Telegram 未配置时直接返回 False 并记录 INFO 日志，不抛异常；  
     - 在 Telegram 配置齐全时调用 `send_telegram_message(...)` 或注入的 `send_fn`，并正确设置 `parse_mode`；  
     - 当底层发送函数抛出异常时记录 ERROR 日志但不向上抛出。  
   - 视需要在 `tests/test_risk_control_integration.py` 或等价集成测试中验证：  
     - 在每日亏损阈值首次触发的集成场景中，通过注入的通知回调成功记录一次通知事件（可使用 mock 代替真实 Telegram 调用）。  
   - 运行 `./scripts/run_tests.sh` 或等价命令，所有既有测试与新增测试全部通过。

## Tasks / Subtasks

- [x] **Task 1 – 设计每日亏损限制通知消息结构（AC1）**  
  - [x] 1.1 在 `notifications/telegram.py` 中新增或完善 `build_daily_loss_limit_triggered_message(...)`：  
        - 接受 `loss_pct`、`limit_pct`、`daily_start_equity`、`current_equity` 等参数；  
        - 使用 MarkdownV2 友好的格式与适当的 emoji；  
        - 确保对特殊字符进行正确转义。  
  - [x] 1.2 在 Dev Notes 中记录最终文案风格与数值格式（小数位数、货币符号等），与 Kill-Switch 通知保持一致。

- [x] **Task 2 – 将通知逻辑与风控入口集成（AC2）**  
  - [x] 2.1 在 `notifications/telegram.py` 中实现 `notify_daily_loss_limit_triggered(...)` 及 `create_daily_loss_limit_notify_callback(...)`：  
        - 封装 Telegram 发送逻辑；  
        - 在缺少配置时优雅跳过并记录日志。  
  - [x] 2.2 在 `bot.py` 的 `_run_iteration()` 中，根据 `TELEGRAM_BOT_TOKEN` / `TELEGRAM_CHAT_ID` 创建每日亏损通知回调，并通过 `check_risk_limits(...)` / `check_daily_loss_limit(...)` 的参数将其注入。  
  - [x] 2.3 确保同一自然日内仅在首次触发每日亏损阈值时发送通知，不因后续迭代重复发送。

- [x] **Task 3 – 单元与集成测试（AC3, AC4）**  
  - [x] 3.1 在 `tests/test_notifications_telegram.py` 中新增针对每日亏损通知的测试（包括成功路径与错误路径）。  
  - [x] 3.2 在 `tests/test_risk_control_integration.py` 或等价文件中添加集成测试，用 mock 回调验证在每日亏损阈值触发场景下恰好调用一次通知逻辑。  
  - [x] 3.3 运行 `./scripts/run_tests.sh`，确保所有测试通过，并在 Dev Notes 中记录任何对日志或文案的调整决定。

## Dev Notes

### Requirements & Context Summary

- 本 Story 属于 **Epic 7.3: 每日亏损限制功能** 的第四个实现 Story，对应 `sprint-status.yaml` 中的 key：`7-3-4-实现每日亏损限制通知`。  
- 需求主要来源：  
  - PRD 《风控系统增强 - 产品需求文档》（`docs/prd-risk-control-enhancement.md`）中的「每日亏损限制功能」部分：  
    - **FR12–FR17** 定义了每日亏损限制的基准、计算与触发逻辑；  
    - **FR18** 明确要求「每日亏损触发暂停时发送包含详细信息的 Telegram 通知」，本 Story 聚焦实现该通知能力；  
    - **FR19–FR21** 要求风控事件具备可审计性与可观测性，本 Story在通知层面配合已有 CSV 事件记录与日志体系。  
  - Epic 文档 `docs/epic-risk-control-enhancement.md` 中 **Story 7.3.4: 实现每日亏损限制通知** 的拆解：  
    - 要求在每日亏损阈值触发（Story 7.3.3）后，通过 Telegram 发送包含亏损百分比、阈值、起始/当前权益与下一步操作建议的详细通知；  
    - 特别强调通知应为后续 Telegram 命令（Epic 7.4）提供清晰上下文。  
  - 已完成的 Stories：  
    - **7.3.1 – 实现每日起始权益记录**：通过 `update_daily_baseline(...)` 维护 `daily_start_equity` / `daily_start_date`。  
    - **7.3.2 – 实现每日亏损百分比计算**：通过 `calculate_daily_loss_pct(...)` 计算并维护 `daily_loss_pct`。  
    - **7.3.3 – 实现每日亏损阈值触发**：通过 `check_daily_loss_limit(...)` 对比 `loss_pct` 与 `DAILY_LOSS_LIMIT_PCT`，在首次达到阈值时设置 `daily_loss_triggered=True` 并调用 `activate_kill_switch(...)`。  
- 本 Story 在上述基础上：  
  - 为每日亏损阈值触发提供**用户可见的、具备行动建议的通知层**；  
  - 保证通知失败不会影响风控核心逻辑与 Kill-Switch 行为；  
  - 与 Epic 7.4 的 Telegram 命令集成（/status、/reset_daily、/resume 等）形成互补。

### Architecture & Implementation Constraints

- **模块边界与职责分配：**  
  - `core/risk_control.py`：负责每日基准、每日亏损计算及阈值触发逻辑（Stories 7.3.1–7.3.3），本 Story 不在此模块中新增通知文本拼装逻辑，只通过回调与接口参数传递所需字段。  
  - `notifications/telegram.py`：集中负责 Telegram 文案构建与发送逻辑，包括 Kill-Switch 与每日亏损通知；本 Story 的主要实现位置应在该模块。  
  - `bot.py`：负责在 `_run_iteration()` 中根据配置构造通知回调，并将其注入风险控制入口，不直接写具体通知文案。  
- **一致性要求：**  
  - 保持与现有 Kill-Switch 通知（Epic 7.2.5）的格式与错误处理模式一致；  
  - 严格复用 `RiskControlState` 与现有 helper 提供的数据，不引入平行的每日亏损状态存储；  
  - 避免在通知模块中「偷偷」修改风控状态，仅消费 `loss_pct`、`daily_start_equity` 等只读信息。  
- **禁止事项：**  
  - 禁止在通知失败时重试过多次或阻塞主循环；  
  - 禁止在通知逻辑中重新计算每日亏损或阈值判定，所有判断由 `check_daily_loss_limit(...)` 负责；  
  - 禁止在本 Story 中实现或修改 Telegram 命令处理逻辑（/kill、/resume、/reset_daily、/status 等），这些属于 Epic 7.4 的范围。

### Project Structure Notes

- 预计主要涉及文件（最终以实际实现为准）：  
  - `notifications/telegram.py` —— 新增每日亏损限制通知相关 helper 与回调工厂；  
  - `core/risk_control.py` —— 通过参数或回调形式调用通知逻辑（不直接依赖 Telegram 实现细节）；  
  - `bot.py` —— 在 `_run_iteration()` 中根据配置构造每日亏损通知回调并注入 `check_risk_limits(...)`；  
  - `tests/test_notifications_telegram.py` —— 新增每日亏损通知的单元测试；  
  - `tests/test_risk_control_integration.py` —— 视需要新增集成测试，覆盖「日亏触发 → Kill-Switch 激活 → 通知被调用」的端到端流程。  
- 整体结构与职责划分应继续遵守 `docs/architecture/06-project-structure-and-mapping.md` 与 `docs/architecture/07-implementation-patterns.md` 中的约定。

### References

- [Source: docs/epic-risk-control-enhancement.md#Story-7.3.4-实现每日亏损限制通知]  
- [Source: docs/prd-risk-control-enhancement.md#每日亏损限制功能]  
- [Source: docs/epics.md#Epic-7.3-每日亏损限制功能-Post-MVP]  
- [Source: docs/sprint-artifacts/7-3-1-实现每日起始权益记录.md]  
- [Source: docs/sprint-artifacts/7-3-2-实现每日亏损百分比计算.md]  
- [Source: docs/sprint-artifacts/7-3-3-实现每日亏损阈值触发.md]  
- [Source: docs/architecture/07-implementation-patterns.md]

## Dev Agent Record

### Context Reference

- `docs/sprint-artifacts/7-3-4-实现每日亏损限制通知.context.xml`（由后续 `story-context` 工作流生成后填充）  
- (相关) `docs/epic-risk-control-enhancement.md#Story-7.3.4-实现每日亏损限制通知`  
- (相关) `docs/prd-risk-control-enhancement.md#每日亏损限制功能`

### Agent Model Used

- Cascade（本 Story 草稿由 SM/AI 协同创建，用于指导后续 Dev Story 实施与代码评审）

### Debug Log References

- 通知发送路径中的日志行为：  
  - 当 Telegram 未配置时，输出 INFO 日志：`Daily loss limit notification skipped: Telegram not configured`  
  - 当通知发送失败时输出 ERROR 日志：`Failed to send daily loss limit notification: <error>`  
  - 通知成功发送时，输出 INFO 日志：`Daily loss limit notification sent: loss_pct=X.XX%, limit_pct=X.XX%`

### Completion Notes List

- **每日亏损限制通知的最终文案格式：**
  ```
  ⚠️ *每日亏损限制已触发*

  *当日亏损:* `-X.XX%`
  *亏损阈值:* `-X.XX%`
  *今日起始权益:* `$X,XXX.XX`
  *当前权益:* `$X,XXX.XX`
  *亏损金额:* `$X,XXX.XX`

  🚨 Kill-Switch 已自动激活，新开仓信号已被阻止。

  💡 恢复交易请使用: `/resume confirm`
  📊 查看状态请使用: `/status`
  ```
- **与 Kill-Switch 的集成方式：**
  - 通过 `check_daily_loss_limit()` 的 `notify_fn` 参数注入通知回调
  - 在 `bot.py` 的 `_run_iteration()` 中使用 `create_daily_loss_limit_notify_callback()` 创建回调
  - 通知仅在 `daily_loss_triggered` 从 False 变为 True 时发送一次
- **PRD FR18–FR21 覆盖情况：**
  - FR18: ✅ 每日亏损触发时发送包含详细信息的 Telegram 通知
  - FR19-FR21: ✅ 通知失败不影响风控逻辑，错误被记录到日志

### File List

- **MODIFIED:**
  - `tests/test_notifications_telegram.py` — 新增每日亏损限制通知的单元测试（3 个测试类，约 20 个测试用例）
  - `tests/test_risk_control_integration.py` — 新增 `DailyLossLimitNotificationIntegrationTests` 集成测试类（6 个测试用例）
- **EXISTING (已实现，本 Story 验证):**
  - `notifications/telegram.py` — 包含 `build_daily_loss_limit_triggered_message()`、`notify_daily_loss_limit_triggered()`、`create_daily_loss_limit_notify_callback()`
  - `core/risk_control.py` — `check_daily_loss_limit()` 支持 `notify_fn` 参数
  - `bot.py` — `_run_iteration()` 中集成每日亏损通知回调  

## Senior Developer Review (AI)

Reviewer: Nick (AI-assisted)

Date: 2025-11-30

Outcome: **Approve**

### Summary

- 所有 Acceptance Criteria（AC1–AC4）均在代码与测试中找到明确实现与证据。  
- 所有已勾选的 Tasks/Subtasks 均有对应实现和测试覆盖，未发现“勾选但未做”的情况。  
- 实现遵守 `core/risk_control.py` / `notifications/telegram.py` / `bot.py` 的模块边界要求，通知逻辑仅通过回调消费风控输出。  
- 新增测试在 `tests/test_notifications_telegram.py` 与 `tests/test_risk_control_integration.py` 中，为每日亏损通知提供了单元与集成覆盖；`./scripts/run_tests.sh` 共 573 个测试全部通过。  

### Acceptance Criteria Validation

- **AC1 – 通知内容与格式：IMPLEMENTED**  
  - 通知文案构建：`notifications/telegram.py::build_daily_loss_limit_triggered_message` 包含：当日亏损百分比 `loss_pct`、亏损阈值 `limit_pct`、`daily_start_equity`、`current_equity`、亏损金额 `loss_amount`，并使用 emoji + MarkdownV2，与 Kill-Switch 通知风格一致。  
  - 单元测试：`tests/test_notifications_telegram.py::TestBuildDailyLossLimitTriggeredMessage` 覆盖典型数值、大小数与格式。
- **AC2 – 与风控逻辑的集成边界：IMPLEMENTED**  
  - 触发逻辑：`core/risk_control.py::check_daily_loss_limit` 仅依赖已有的 `calculate_daily_loss_pct` 与 `daily_loss_limit_pct`，在 `daily_loss_triggered` 为 False 且阈值首次被触及时触发 Kill-Switch 并调用 `notify_fn`。  
  - 通知回调：`notifications/telegram.py::create_daily_loss_limit_notify_callback` 在缺少 `bot_token` 或 `chat_id` 时返回 None，从而优雅跳过通知；`bot._run_iteration` 将该回调注入 `check_risk_limits(..., notify_daily_loss_fn=...)`。  
  - 集成测试：`DailyLossLimitNotificationIntegrationTests` 中前两个用例验证首次触发调用通知、后续迭代不重复通知。
- **AC3 – 错误处理与可观测性：IMPLEMENTED**  
  - 发送错误与 Markdown 降级：`notifications/telegram.py::send_telegram_message` 对非 200 响应记录 WARNING 日志，并在 400 + "can't parse entities" 场景下做一次不带 `parse_mode` 的降级重试，同时对降级失败记录 WARNING/ERROR。  
  - 风控侧保护：`core/risk_control.py::check_daily_loss_limit` 在 Kill-Switch 状态与事件记录完成后，使用 try/except 包裹 `notify_fn(...)`，异常仅记录 ERROR 日志 `Failed to send daily loss limit notification`，不回滚 Kill-Switch 或 `daily_loss_triggered` 状态。  
  - 集成测试：`DailyLossLimitNotificationIntegrationTests::test_notification_failure_does_not_affect_kill_switch_activation` 验证通知抛异常时 Kill-Switch 仍被激活且 `daily_loss_triggered` 为 True。
- **AC4 – 单元与集成测试覆盖：IMPLEMENTED**  
  - 单元测试：`tests/test_notifications_telegram.py` 中三个每日亏损通知相关测试类覆盖文案内容/格式、Telegram 未配置与配置齐全、默认与自定义发送函数、异常路径等。  
  - 集成测试：`tests/test_risk_control_integration.py::DailyLossLimitNotificationIntegrationTests` 覆盖从 `update_daily_baseline` → `check_risk_limits` → `check_daily_loss_limit` → 通知回调的完整调用链。  
  - 所有测试通过：`./scripts/run_tests.sh` 输出显示 573 个测试成功。

### Task Completion Validation

- **Task 1 – 设计每日亏损限制通知消息结构（已完成）**  
  - 1.1：`build_daily_loss_limit_triggered_message(...)` 的实现与对应单元测试已存在。  
  - 1.2：Dev Notes 中已记录最终文案结构与字段，且与 Kill-Switch 通知风格保持一致。
- **Task 2 – 将通知逻辑与风控入口集成（已完成）**  
  - 2.1：`notify_daily_loss_limit_triggered(...)` 与 `create_daily_loss_limit_notify_callback(...)` 已在 `notifications/telegram.py` 中实现，并通过单元测试验证行为。  
  - 2.2：`bot._run_iteration()` 中创建每日亏损通知回调并注入 `check_risk_limits(...)` 的实现与集成测试均已就绪。  
  - 2.3：`check_daily_loss_limit(...)` 中 `daily_loss_triggered` 的保护语义，连同集成测试，保证同一自然日内仅首次触发时发送通知。  
- **Task 3 – 单元与集成测试（已完成）**  
  - 3.1：`tests/test_notifications_telegram.py` 中新增每日亏损通知相关测试。  
  - 3.2：`tests/test_risk_control_integration.py` 中新增 `DailyLossLimitNotificationIntegrationTests`。  
  - 3.3：通过 `./scripts/run_tests.sh` 验证所有既有与新增测试全部通过。

> 结论：所有被标记为已完成的任务在代码与测试中均找到明确实现与证据，未发现“勾选但未做”或“实现与描述严重不符”的情况。

### Test Coverage and Gaps

- 单元测试：覆盖文案内容/格式、Telegram 未配置与配置齐全、默认与自定义发送函数、异常路径等。  
- 集成测试：覆盖从每日基准更新到 Kill-Switch 激活再到通知发送的完整链路。  
- 未发现明显缺失的关键路径测试；如未来引入 `/reset_daily`、`/status` 等命令时，建议再补充“命令 + 通知”的交互测试。

### Architectural Alignment & Security Notes

- 架构层面：风险控制逻辑仍集中在 `core.risk_control.py`，通知逻辑集中在 `notifications/telegram.py`，主循环仅负责装配与注入回调，符合文档中对模块边界与职责划分的约束。  
- 安全性：通知模块未引入新的外部依赖；对 Telegram API 的调用通过单一 helper 统一管理，并在异常时进行日志记录与降级处理，不会影响本地风控与 Kill-Switch 状态。  
- 性能：通知仅在阈值首次触发时发送一次，不会在主循环内产生高频、阻塞型调用。

### Action Items

**Code Changes Required:**

- 无必需代码改动，Story 可直接进入 `done` 状态。

**Advisory Notes:**

- [Note] 未来如引入 `/reset_daily` 命令，可在文档中进一步强调“通知文案与命令使用说明”的一一对应关系，方便用户从通知直接跳转到下一步操作。  
- [Note] Story Context XML 中的 `<metadata><status>` 仍为 `drafted`，后续文档整理时可统一与 `sprint-status.yaml` / Story 文件状态对齐。

### Change Log

- 2025-11-30: 初始 Story 草稿由 `/create-story` 工作流基于 PRD/Epic/架构文档生成，状态设为 `drafted`，等待后续 `story-context` 与 Dev Story 实施。
- 2025-11-30: Story 实现完成，添加单元测试和集成测试，所有 573 个测试通过，状态更新为 `review`。
- 2025-11-30: Story 通过 Senior Developer Review，所有 AC 与已完成任务均验证无缺失，状态建议更新为 `done`.
