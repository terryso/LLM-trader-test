<story-context id='.bmad/bmm/workflows/4-implementation/story-context/template' v='1.0'>
  <metadata>
    <epicId>7.4</epicId>
    <storyId>4</storyId>
    <title>实现 reset_daily 命令</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-01T03:00:00+08:00</generatedAt>
    <generator>BMAD Story Context Workflow (manual agent execution)</generator>
    <sourceStoryPath>docs/sprint-artifacts/7-4-4-实现-reset-daily-命令.md</sourceStoryPath>
  </metadata>

  <story>
    <asA><![CDATA[As a user]]></asA>
    <iWant><![CDATA[I want to manually reset the daily loss baseline via a Telegram command]]></iWant>
    <soThat><![CDATA[so that I can safely resume trading after reviewing a large drawdown day and explicitly deciding to start a new risk window.]]></soThat>
    <tasks><![CDATA[
- [ ] Task 1 – 设计 /reset_daily 命令语义与交互（AC1, AC2, AC3）  
- [ ] Task 2 – 在风控核心中抽象每日基准重置 helper（AC1, AC2, AC4）  
- [ ] Task 3 – 在 Telegram 命令层实现 /reset_daily（AC1–AC4）  
- [ ] Task 4 – 测试与回归（AC5）  
    ]]></tasks>
  </story>

  <acceptanceCriteria><![CDATA[
1. AC1 – /reset_daily 正确重置每日亏损基准：在风控启用且 Telegram 配置正确时，将 daily_start_equity、daily_start_date 更新为当前权益和 UTC 日期，并将 daily_loss_pct 与 daily_loss_triggered 重置为安全初始值，行为幂等。  
2. AC2 – 与 Kill-Switch / 每日亏损限制协同：在因每日亏损限制触发 Kill-Switch 的场景下，/reset_daily 重置每日基准并清除 daily_loss_triggered，同时与 /resume confirm 的职责边界明确，不误绕过风控保护。  
3. AC3 – 用户反馈与文案：/reset_daily 成功时，通过 Telegram 回复结构化 MarkdownV2 文本，展示新基准权益、当前亏损（应为 0.00%）、Kill-Switch 状态与下一步建议；风控未启用或权益不可用时给出友好降级提示而不修改状态。  
4. AC4 – 安全性、健壮性与审计：仅接受授权 Chat ID 的 /reset_daily 命令；任何异常不影响主循环与本地风控逻辑，并记录 WARNING/ERROR 日志；成功重置时记录结构化日志并可选写入 RISK_CONTROL/DAILY_BASELINE_RESET 审计事件。  
5. AC5 – 单元测试与回归：在 tests/test_notifications_telegram_commands.py 等处覆盖正常路径、未授权 chat、风控关闭、权益不可用与 /resume 协同等场景，./scripts/run_tests.sh 全量通过。  
  ]]></acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd-risk-control-enhancement.md</path>
        <title>风控系统增强 - 产品需求文档</title>
        <section>每日亏损限制功能 / Telegram 命令集成</section>
        <snippet>定义每日亏损限制的 FR12–FR18 以及 /reset_daily 命令在手动重置每日基准中的职责, 说明当日亏损触发 Kill-Switch 后用户如何通过命令恢复风险窗口。</snippet>
      </doc>
      <doc>
        <path>docs/epic-risk-control-enhancement.md</path>
        <title>风控系统增强 - Epic 与 Story 分解</title>
        <section>Epic 7.4 / Story 7.4.4: 实现 /reset_daily 命令</section>
        <snippet>从 Epic 视角拆解 7.4.4, 给出 handle_reset_daily_command 伪代码, 明确需要重置 daily_start_equity / daily_start_date / daily_loss_pct / daily_loss_triggered 并与 Kill-Switch 协同。</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>LLM-trader-test - Epic Breakdown</title>
        <section>Epic 7: 风控系统增强 / Epic 7.4: Telegram 命令集成</section>
        <snippet>说明风控系统增强与 Telegram 命令集成的整体目标, /reset_daily 与 Epic 7.3 每日亏损限制和 Epic 7.4 命令控制一起构成应急控制闭环。</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/7-4-1-实现-telegram-命令接收机制.md</path>
        <title>Story 7.4.1: 实现 Telegram 命令接收机制</title>
        <section>Dev Notes / Architecture &amp; Implementation Constraints</section>
        <snippet>定义 TelegramCommandHandler、命令轮询流程与 chat 过滤策略, /reset_daily 将复用同一命令接收和安全过滤基础设施。</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/7-4-2-实现-kill-和-resume-命令.md</path>
        <title>Story 7.4.2: 实现 kill 和 resume 命令</title>
        <section>Dev Notes / Requirements & Context Summary</section>
        <snippet>描述 /kill 与 /resume 命令如何与 RiskControlState、Kill-Switch 与每日亏损限制交互, /reset_daily 需要在相同语义下设计恢复路径与日志/审计行为。</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/7-4-3-实现-status-命令.md</path>
        <title>Story 7.4.3: 实现 status 命令</title>
        <section>Dev Notes / Learnings from Previous Story</section>
        <snippet>总结 /status 只读展示 RiskControlState 与每日亏损状态的经验, 为 /reset_daily 提供状态字段与文案风格上的对齐参考。</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/7-3-4-实现每日亏损限制通知.md</path>
        <title>Story 7.3.4: 实现每日亏损限制通知</title>
        <section>Dev Notes / References</section>
        <snippet>定义每日亏损限制触发时的通知字段与用户指引, 其中已经向用户暴露 /reset_daily 与 /resume 等命令, 本 Story 负责落实 /reset_daily 的具体行为。</snippet>
      </doc>
      <doc>
        <path>docs/architecture/06-project-structure-and-mapping.md</path>
        <title>架构: 项目结构与 PRD 映射</title>
        <section>Telegram 通知与风控映射</section>
        <snippet>说明 notifications/telegram.py 与 core/risk_control.py 在架构中的角色与依赖关系, /reset_daily 需要遵守相同分层与依赖方向。</snippet>
      </doc>
      <doc>
        <path>docs/architecture/07-implementation-patterns.md</path>
        <title>实现模式与一致性规则</title>
        <section>错误处理与日志模式</section>
        <snippet>给出外部服务调用与风控相关逻辑的日志/错误处理约定, /reset_daily 命令的实现应沿用这些模式避免静默失败。</snippet>
      </doc>
    </docs>

    <code>
      <codeArtifact>
        <path>notifications/telegram_commands.py</path>
        <kind>notifications</kind>
        <symbol>TelegramCommand, TelegramCommandHandler, process_telegram_commands, handle_kill_command, handle_resume_command, handle_status_command, create_kill_resume_handlers</symbol>
        <lines>1-876</lines>
        <reason>命令接收与分发的核心模块, /reset_daily 将在此处新增命令 handler 并通过 handlers dict 注册, 复用现有日志与审计封装。</reason>
      </codeArtifact>
      <codeArtifact>
        <path>notifications/telegram.py</path>
        <kind>notifications</kind>
        <symbol>send_telegram_message, create_daily_loss_limit_notify_callback, create_kill_switch_notify_callbacks</symbol>
        <lines>1-260</lines>
        <reason>封装 Telegram 发送逻辑与风控相关通知 helper, /reset_daily 的确认文案应通过该模块或等价 helper 发送。</reason>
      </codeArtifact>
      <codeArtifact>
        <path>core/risk_control.py</path>
        <kind>risk-control</kind>
        <symbol>RiskControlState, update_daily_baseline, calculate_daily_loss_pct, check_daily_loss_limit, check_risk_limits, apply_kill_switch_env_override</symbol>
        <lines>17-402</lines>
        <reason>定义风控状态与每日亏损逻辑, /reset_daily 需要在此模块内通过专门 helper 重置每日基准并与 Kill-Switch 协同。</reason>
      </codeArtifact>
      <codeArtifact>
        <path>bot.py</path>
        <kind>main-loop</kind>
        <symbol>_run_iteration, poll_telegram_commands</symbol>
        <lines>684-772</lines>
        <reason>展示 Telegram 命令轮询与风控检查在主循环中的顺序, /reset_daily 必须在相同命令处理链路中执行, 不直接耦合到主循环。</reason>
      </codeArtifact>
      <codeArtifact>
        <path>tests/test_notifications_telegram_commands.py</path>
        <kind>tests</kind>
        <symbol>TestProcessTelegramCommands, TestHandleKillCommand, TestHandleResumeCommand, TestHandleStatusCommand</symbol>
        <lines>1-1200</lines>
        <reason>覆盖命令分发与 /kill /resume /status 流程, 将在此基础上新增 /reset_daily 相关测试用例与集成流测试。</reason>
      </codeArtifact>
      <codeArtifact>
        <path>tests/test_risk_control.py</path>
        <kind>tests</kind>
        <symbol>RiskControlState, update_daily_baseline, calculate_daily_loss_pct, check_daily_loss_limit 测试</symbol>
        <lines>1-260</lines>
        <reason>验证每日基准与亏损计算逻辑, 为 /reset_daily 重置基准后的数值行为提供回归保障。</reason>
      </codeArtifact>
      <codeArtifact>
        <path>tests/test_risk_control_integration.py</path>
        <kind>tests</kind>
        <symbol>风控集成测试: Kill-Switch 与每日亏损限制</symbol>
        <lines>1-260</lines>
        <reason>验证在真实交易循环中每日亏损触发 Kill-Switch 的行为, /reset_daily 的实现需要与这些场景保持一致。</reason>
      </codeArtifact>
      <codeArtifact>
        <path>config/settings.py</path>
        <kind>config</kind>
        <symbol>RISK_CONTROL_ENABLED, DAILY_LOSS_LIMIT_ENABLED, DAILY_LOSS_LIMIT_PCT, TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID</symbol>
        <lines>580-620</lines>
        <reason>定义风控开关、每日亏损限制与 Telegram 相关环境变量, /reset_daily 必须尊重这些配置并在禁用场景下做安全降级。</reason>
      </codeArtifact>
    </code>

    <dependencies>
      <dependency ecosystem='python' name='requests' version='2.31.0' />
      <dependency ecosystem='python' name='python-dotenv' version='1.0.0' />
      <dependency ecosystem='python' name='pandas' version='2.2.3' />
      <dependency ecosystem='python' name='numpy' version='2.1.3' />
      <dependency ecosystem='python' name='pytest' version='dev' />
    </dependencies>
  </artifacts>

  <constraints><![CDATA[
- /reset_daily 必须通过 core/risk_control.py 中的专门 helper 重置每日基准, 不允许在命令层直接修改 RiskControlState 字段, 以保持所有风控状态变更集中管理。  
- /reset_daily 不得隐式绕过每日亏损限制与 Kill-Switch 保护, 是否自动解除因每日亏损触发的 Kill-Switch 必须在实现与文档中明确, 默认策略应鼓励显式使用 /resume confirm。  
- 命令处理逻辑需与 /kill、/resume、/status 保持一致的错误处理与日志模式, 所有网络或状态错误记录 WARNING/ERROR 而不影响主循环。  
- 回复文案需使用 Telegram MarkdownV2, 并通过统一的转义 helper 处理特殊字符, 避免格式错误导致消息发送失败。  
- 未授权 Chat ID 的 /reset_daily 命令必须被忽略并记录 WARNING 日志, 不返回任何敏感状态变化信息。  
  ]]></constraints>

  <interfaces>
    <interface>
      <name>RiskControlState</name>
      <kind>dataclass</kind>
      <signature>RiskControlState(kill_switch_active: bool, kill_switch_reason: Optional[str], kill_switch_triggered_at: Optional[str], daily_start_equity: Optional[float], daily_start_date: Optional[str], daily_loss_pct: float, daily_loss_triggered: bool)</signature>
      <path>core/risk_control.py</path>
    </interface>
    <interface>
      <name>update_daily_baseline</name>
      <kind>function</kind>
      <signature>update_daily_baseline(state: RiskControlState, current_equity: float) -&gt; None</signature>
      <path>core/risk_control.py</path>
    </interface>
    <interface>
      <name>calculate_daily_loss_pct</name>
      <kind>function</kind>
      <signature>calculate_daily_loss_pct(state: RiskControlState, current_equity: float) -&gt; float</signature>
      <path>core/risk_control.py</path>
    </interface>
    <interface>
      <name>check_daily_loss_limit</name>
      <kind>function</kind>
      <signature>check_daily_loss_limit(state: RiskControlState, current_equity: float, daily_loss_limit_enabled: bool, daily_loss_limit_pct: float, risk_control_enabled: bool, positions_count: int, notify_fn, record_event_fn) -&gt; bool</signature>
      <path>core/risk_control.py</path>
    </interface>
    <interface>
      <name>TelegramCommand</name>
      <kind>dataclass</kind>
      <signature>TelegramCommand(command: str, args: List[str], chat_id: str, message_id: int, raw_text: str, raw_update: Dict[str, Any])</signature>
      <path>notifications/telegram_commands.py</path>
    </interface>
    <interface>
      <name>TelegramCommandHandler</name>
      <kind>class</kind>
      <signature>TelegramCommandHandler(bot_token: str, allowed_chat_id: str, last_update_id: int = 0, timeout: int = 5, limit: int = 10)</signature>
      <path>notifications/telegram_commands.py</path>
    </interface>
    <interface>
      <name>process_telegram_commands</name>
      <kind>function</kind>
      <signature>process_telegram_commands(commands: List[TelegramCommand], command_handlers: Optional[Dict[str, Callable[[TelegramCommand], None]]] = None) -&gt; None</signature>
      <path>notifications/telegram_commands.py</path>
    </interface>
  </interfaces>

  <tests>
    <standards><![CDATA[
- 使用 pytest 作为测试框架, Telegram 命令相关测试集中在 tests/test_notifications_telegram_commands.py, 通过 mock requests 与 fake RiskControlState 避免真实外部调用。  
- /reset_daily 的测试应覆盖不同 RiskControlState 组合（Kill-Switch 激活/未激活、daily_loss_triggered True/False、风控启用/禁用）以及权益不可用等边界情况。  
- 对风控核心 helper 的测试继续放在 tests/test_risk_control*.py 中, 确保每日基准重置与日亏触发逻辑在修改后仍然符合 PRD 与 Epic 要求。  
    ]]></standards>
    <locations><![CDATA[
- tests/test_notifications_telegram_commands.py  
- tests/test_risk_control.py  
- tests/test_risk_control_integration.py  
    ]]></locations>
    <ideas><![CDATA[
- 构造多组 RiskControlState（例如: daily_loss_triggered=True 且 Kill-Switch 激活, 仅 Kill-Switch 激活, 正常状态）, 模拟 /reset_daily 命令并验证状态字段与回复文案是否符合 AC1/AC2/AC3。  
- 模拟风控关闭或 total_equity_fn 返回 None 的场景, 验证 /reset_daily 不修改状态并返回正确的降级提示, 同时记录 WARNING/ERROR 日志。  
- 使用未授权 chat_id 发送 /reset_daily, 验证 handler 不修改任何状态、不发送回复文本且记录 WARNING 日志。  
- 在命令处理过程中注入异常（例如 fake helper 抛出错误）, 验证错误被捕获、日志记录 ERROR 且主循环可继续运行。  
    ]]></ideas>
  </tests>
</story-context>
