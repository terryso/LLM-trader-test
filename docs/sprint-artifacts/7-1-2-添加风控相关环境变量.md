# Story 7.1.2: 添加风控相关环境变量

Status: review

## Story

As a **user**,
I want **to configure risk control via environment variables**,
so that **I can customize risk limits without changing code**.

## Acceptance Criteria

1. **AC1**: 在 `config/settings.py` 中添加以下配置常量，并通过环境变量解析：
   - `RISK_CONTROL_ENABLED`（默认：`true`）
   - `KILL_SWITCH`（默认：`false`）
   - `DAILY_LOSS_LIMIT_ENABLED`（默认：`true`）
   - `DAILY_LOSS_LIMIT_PCT`（默认：`5.0`）
2. **AC2**: 在 `.env.example` 中添加上述 4 个环境变量示例和中文说明，解释默认值与风险含义。
3. **AC3**: 为 `DAILY_LOSS_LIMIT_PCT` 等数值型配置添加基本验证（例如范围在 `0`–`100` 之间），无效配置会记录 warning 并回退到安全默认值。
4. **AC4**: 添加单元测试覆盖：默认值加载、环境变量覆盖、无效输入回退逻辑。

## Tasks / Subtasks

- [x] **Task 1**: 在 `config/settings.py` 中加载风控相关环境变量（AC: 1）
  - [x] 1.1 定义 `RISK_CONTROL_ENABLED` / `KILL_SWITCH` / `DAILY_LOSS_LIMIT_ENABLED` / `DAILY_LOSS_LIMIT_PCT`
  - [x] 1.2 使用统一的布尔解析策略（如 `"true" / "1" / "yes"` 视为真）
  - [x] 1.3 将 `DAILY_LOSS_LIMIT_PCT` 解析为 `float`，设置默认值 `5.0`

- [x] **Task 2**: 在 `.env.example` 中更新风控相关配置示例（AC: 2）
  - [x] 2.1 添加 4 个新环境变量条目
  - [x] 2.2 为每个变量补充用途说明和默认行为
  - [x] 2.3 标注「开启实盘 / 提高阈值需自担风险」等警示语

- [x] **Task 3**: 添加配置验证逻辑（AC: 3）
  - [x] 3.1 对 `DAILY_LOSS_LIMIT_PCT` 做范围检查（例如 `0 < 值 <= 100`）
  - [x] 3.2 无效值时记录 warning 日志，并回退到默认值
  - [x] 3.3 如有需要，为未来扩展其他风控阈值预留验证入口

- [x] **Task 4**: 添加单元测试（AC: 4）
  - [x] 4.1 在现有 `tests/test_config_and_env.py` 或新建专门测试文件中覆盖风控配置
  - [x] 4.2 测试默认配置：在未设置环境变量时得到预期默认值
  - [x] 4.3 测试环境变量覆盖：设置不同组合的布尔值 / 百分比
  - [x] 4.4 测试无效数值输入时回退到默认值并记录日志（可使用 caplog）

## Dev Notes

### Requirements & Context Summary

- 本 Story 由风控增强 PRD 与 `epic-risk-control-enhancement.md` 中的 **Epic 7.1** 衍生，聚焦于「通过环境变量控制风控行为」。
- Tech Spec `tech-spec-epic-7-1.md` 要求：
  - 提供总开关 `RISK_CONTROL_ENABLED`，默认启用风控。
  - 提供启动时 Kill-Switch 状态 `KILL_SWITCH`，用于一键暂停新开仓。
  - 提供每日亏损限制开关 `DAILY_LOSS_LIMIT_ENABLED` 与阈值 `DAILY_LOSS_LIMIT_PCT`。
- 现有实现中，`portfolio_state.json` 和 `RiskControlState` 已为后续每日亏损 / Kill-Switch 行为提供状态承载，本 Story 主要补齐「配置入口」。

### Architecture & Implementation Constraints

- **配置入口集中于 `config/settings.py`**：
  - 遵循现有配置模式，避免在业务代码中直接调用 `os.getenv`。
  - 风控相关配置应当与现有交易 / LLM / 交易所配置保持一致的风格与命名。
- **默认安全**：
  - `RISK_CONTROL_ENABLED=True`，`DAILY_LOSS_LIMIT_ENABLED=True`，默认即启用基础风控。
  - `KILL_SWITCH=False`，避免意外阻塞交易。
  - `DAILY_LOSS_LIMIT_PCT=5.0` 为保守默认值，允许后续通过配置调整。
- **向后兼容**：
  - 若环境变量未设置，行为应与当前无风控配置时代保持兼容且更安全，不应导致 Bot 启动失败。

### Learnings from Previous Story

**From Story 7-1-1-定义-riskcontrolstate-数据结构 (Status: done)**

- **New Files / Structures**
  - `core/risk_control.py` 中已定义 `RiskControlState` dataclass 及 `to_dict` / `from_dict` 方法，可直接作为本 Story 的状态承载层。
  - `tests/test_risk_control.py` 已为风控状态提供较完善的单测示例，可参考其模式设计本 Story 的配置测试。
- **Patterns to Reuse**
  - 使用 dataclass + `asdict` 的序列化模式，保持 JSON 结构简洁、可扩展。
  - 在 `from_dict()` 中通过 `.get()` 提供字段默认值的方式，保证缺失字段时的前向兼容性。
- **Implications for This Story**
  - 本 Story 应复用现有日志与配置加载模式，避免在多个模块中复制环境变量解析逻辑。
  - 在 Dev Notes 和后续实现中，应明确「环境变量配置优先级高于持久化状态」的原则（参见 Tech Spec 风险章节）。

### Project Structure Notes

- 预期受影响文件：
  - `config/settings.py` —— 新增风控相关配置常量。
  - `.env.example` —— 新增环境变量条目与说明。
  - `tests/test_config_and_env.py` 或等价测试文件 —— 扩展以覆盖新配置。
- 与 `core/risk_control.py` / `tests/test_risk_control.py` 的关系：
  - 配置模块负责「是否启用」「阈值设置」，状态模块负责「当前状态与历史状态」。
  - 不在本 Story 中改变 `portfolio_state.json` 结构，仅依赖已有 `risk_control` 字段。

### References

- [Source: docs/epic-risk-control-enhancement.md#Story-7.1.2-添加风控相关环境变量]
- [Source: docs/sprint-artifacts/tech-spec-epic-7-1.md#Objectives-and-Scope]
- [Source: docs/sprint-artifacts/7-1-1-定义-riskcontrolstate-数据结构.md#Dev-Notes]
- [Source: docs/prd-risk-control-enhancement.md#功能需求]
- [Source: docs/architecture/06-project-structure-and-mapping.md]
- [Source: docs/architecture/07-implementation-patterns.md]

## Dev Agent Record

### Context Reference

- [7-1-1-定义-riskcontrolstate-数据结构.context.xml]
- [tech-spec-epic-7-1.context.xml]（如存在，由后续 Story Context 工作流生成）
 - [7-1-2-添加风控相关环境变量.context.xml]

### Agent Model Used

Claude 3.5 Sonnet (Cascade)

### Debug Log References (Planned)

- 计划在实现阶段记录以下关键事件：
  - 风控配置加载：记录四个配置的最终值及来源（默认 / 环境变量）。
  - 无效配置回退：记录 warning 日志，包含原始输入与回退默认值。
  - 配置变更对行为的影响：例如开启 / 关闭每日亏损限制时的行为差异。

### Completion Notes List

- ✅ 配置加载逻辑实现完成：在 `config/settings.py` 中添加了 4 个风控配置常量
- ✅ `.env.example` 更新完成：添加了 4 个环境变量条目及中文说明
- ✅ 单元测试覆盖完成：新建 `tests/test_risk_control_config.py`，15 个测试全部通过
- ✅ 范围验证实现：`_parse_float_env_with_range` 函数支持范围检查和 warning 日志

### File List

**NEW:**
- `tests/test_risk_control_config.py` - 风控配置单元测试（15 个测试用例）

**MODIFIED:**
- `config/settings.py` - 新增 `_parse_float_env_with_range` 函数和 4 个风控配置常量
- `.env.example` - 新增风控相关环境变量示例及中文说明

---

## Change Log

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| 0.1 | 2025-11-30 | Bob (SM) | 初始 Story 草稿（通过 *create-story 工作流生成） |
| 1.0 | 2025-11-30 | Amelia (Dev) | 实现完成：4 个风控配置常量、.env.example 更新、15 个单元测试 |
