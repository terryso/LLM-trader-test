<story-context id="LLM-trader-test/story-8-2" v="1.0">
  <metadata>
    <epicId>8</epicId>
    <storyId>2</storyId>
    <title>Telegram `/config` 命令接口</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-01T00:00:00Z</generatedAt>
    <generator>BMAD Story Context Workflow (simulated)</generator>
    <sourceStoryPath>docs/sprint-artifacts/8-2-telegram-config-命令接口.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>operator of the trading bot</asA>
    <iWant>a `/config` command with list/get/set subcommands</iWant>
    <soThat>I can inspect and adjust key runtime parameters via Telegram</soThat>
    <tasks>
      - Task 1：在 notifications/telegram_commands.py 中注册 `/config` 命令入口，并设计 list/get/set 子命令解析与帮助文案（与 7.4.x 命令风格一致）。
      - Task 2：实现 `/config list` 子命令，使用 config.settings 中的 effective getters 读取 4 个白名单 key 当前生效值，并以适合 Telegram 的文本/表格格式返回。
      - Task 3：实现 `/config get &lt;KEY&gt;` 子命令，使用 runtime_overrides.get_override_whitelist 与 validate_override_value 判断 key 合法性，并返回当前值与合法取值范围/枚举说明。
      - Task 4：实现 `/config set &lt;KEY&gt; &lt;VALUE&gt;` 子命令，复用 runtime_overrides.set_runtime_override 公共 API 完成写入，并在非法取值时返回清晰错误与合法值提示，为后续权限与审计 Story 预留扩展点。
      - Task 5：为 `/config list|get|set` 新增测试（tests/test_telegram_config_commands.py），覆盖正常与异常路径，并通过 ./scripts/run_tests.sh 确认与现有 Telegram 命令测试兼容。
    </tasks>
  </story>

  <acceptanceCriteria>
    - AC1：在 Telegram Bot 中实现 `/config list`，返回 TRADING_BACKEND、MARKET_DATA_BACKEND、TRADEBOT_INTERVAL、TRADEBOT_LLM_TEMPERATURE 四个白名单配置项的当前生效值，文案清晰，适合聊天窗口阅读。
    - AC2：在 Telegram Bot 中实现 `/config get &lt;KEY&gt;`，对合法 key 返回当前值和合法取值范围/枚举说明，对非法 key 返回错误信息并列出支持的 key 列表。
    - AC3：在 Telegram Bot 中实现 `/config set &lt;KEY&gt; &lt;VALUE&gt;`，对合法 key/value 通过 runtime overrides 层更新配置并返回 old_value/new_value，对非法 value 返回明确错误与合法值提示，不抛出未捕获异常。
  </acceptanceCriteria>

  <artifacts>
    <docs>
      - path: docs/epics.md
        title: LLM-trader-test - Epic Breakdown
        section: Story 8.2 - Telegram `/config` 命令接口
        snippet: 描述 Epic 8 下的 Story 8.2，要求在 Telegram Bot 中实现 `/config list|get|set` 三个子命令，通过 runtime overrides 层修改 4 个白名单配置项，并对非法 key/value 返回清晰错误与合法取值范围说明。
      - path: docs/epics.md
        title: LLM-trader-test - Epic Breakdown
        section: Epic 8 - Telegram 远程运营配置管理（Runtime Config Control）
        snippet: 说明 Epic 8 的整体目标：基于 Telegram `/config` 命令在运行时调整 TRADING_BACKEND、MARKET_DATA_BACKEND、TRADEBOT_INTERVAL、TRADEBOT_LLM_TEMPERATURE，并通过 runtime overrides 层覆盖 env 值，所有变更需要权限校验与审计日志。
      - path: docs/prd.md
        title: DeepSeek Paper Trading Bot 产品需求文档
        section: 4.1 交易主循环 / 4.3 LLM 配置与 Prompt 管理
        snippet: 描述交易主循环如何通过环境变量控制运行 interval，以及 LLM 模型与温度等参数；当前所有配置变更需要修改 .env 并重启进程，为通过 Telegram 在运行时调整这些参数提供产品背景。
      - path: docs/architecture/06-project-structure-and-mapping.md
        title: 架构 - 项目结构与 PRD 映射
        section: 6. 项目结构与源码树 / PRD 功能块到架构组件的映射
        snippet: 给出 config/settings.py 与 notifications/telegram.py 所在分层位置，并将 PRD 的「LLM 配置与 Prompt 管理」与「Telegram 通知」映射到具体模块，是设计 `/config` 命令落点与依赖关系的重要参考。
      - path: docs/architecture/07-implementation-patterns.md
        title: 架构 - 实现模式与一致性规则
        section: 7.2 目录与代码结构 / 7.4 通信与耦合模式 / 7.8 测试与校验模式
        snippet: 规定配置集中在 config/，通知与 Telegram 逻辑集中在 notifications/，测试统一位于 tests/ 并使用 pytest；新增 `/config` 命令必须遵守这些位置与测试模式，避免跨层耦合。
      - path: docs/sprint-artifacts/8-1-运行时配置覆盖层-runtime-overrides.md
        title: Story 8.1 - 运行时配置覆盖层（Runtime Overrides）
        section: Dev Notes / Dev Agent Record
        snippet: 详细记录了 runtime overrides 容器、白名单 key、验证逻辑以及 effective getters 的实现与测试范围，是在 `/config` 命令中安全复用 overrides API 的主要依据。
    </docs>

    <code>
      - path: config/runtime_overrides.py
        kind: config-module
        symbol: RuntimeOverrides, set_runtime_override, get_runtime_override, get_override_whitelist, validate_override_value
        lines: 21-338
        reason: 定义 runtime overrides 白名单、合法取值集合与公共 API；`/config set` 必须依赖这些函数进行 key/value 校验与写入，而不是自己维护一套平行的状态。
      - path: config/settings.py
        kind: config-module
        symbol: TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID, get_effective_trading_backend, get_effective_market_data_backend, get_effective_interval, get_effective_check_interval, get_effective_llm_temperature
        lines: 356-408, 611-738
        reason: 集中管理 Telegram 相关 API 配置与 4 个白名单 key 的 effective getters；`/config list|get` 需要通过这些 getter 读取当前生效配置值。
      - path: notifications/telegram_commands.py
        kind: telegram-commands
        symbol: TelegramCommand, TelegramCommandHandler, process_telegram_commands, COMMAND_REGISTRY, handle_status_command, handle_risk_command, handle_kill_command, handle_resume_command, handle_help_command, handle_unknown_command
        lines: 1-383, 411-671
        reason: 提供 Telegram 命令解析、chat 过滤、命令分发与现有 /kill、/resume、/status、/risk、/reset_daily、/help 等命令实现；`/config` 命令需要在此模块中以相同风格注册并实现。
      - path: notifications/telegram.py
        kind: telegram-notifications
        symbol: send_telegram_message, escape_markdown, build_kill_switch_activated_message, notify_kill_switch_activated, build_daily_loss_limit_triggered_message
        lines: 1-119, 188-335, 400-507
        reason: 封装了 Telegram 发送逻辑与 Markdown/MarkdownV2 转义规则；`/config` 命令的响应消息应复用 send_telegram_message 或兼容的 send 函数，并遵守相同的转义策略。
      - path: tests/test_notifications_telegram_commands.py
        kind: test
        symbol: TestCommandParsing, TestChatIdFiltering, TestOffsetMechanism, TestHandleKillCommand, TestHandleResumeCommand, TestProcessTelegramCommands
        lines: 1-671
        reason: 覆盖 TelegramCommandHandler 行为以及现有命令 handler 的 AC，提供命令解析、chat 过滤、错误处理与日志模式的示例；为新增 `/config` 命令及其测试提供直接参考。
      - path: tests/test_notifications_telegram.py
        kind: test
        symbol: TestSendTelegramMessage, TestSendEntrySignalToTelegram, TestSendCloseSignalToTelegram, TestBuildDailyLossLimitTriggeredMessage
        lines: 1-272
        reason: 测试 Telegram 发送与 Markdown 转义行为，确保 send_telegram_message 在各种错误场景下不会抛出异常；`/config` 命令构建的消息需要兼容这些发送与转义模式。
    </code>

    <dependencies>
      - ecosystem: python
        manifests:
          - path: requirements.txt
        packages:
          - name: python-dotenv
            version: "1.0.0"
          - name: requests
            version: "2.31.0"
          - name: streamlit
            version: "1.38.0"
          - name: hyperliquid-python-sdk
            version: ">=0.9.0"
          - name: eth-account
            version: ">=0.10.0"
          - name: ccxt
            version: "(see installed version)"
    </dependencies>
  </artifacts>

  <constraints>
    - `/config` 命令必须只通过 config.runtime_overrides 与 config.settings 提供的公共 API 访问和修改配置，禁止直接读写 os.environ 或 RuntimeOverrides 内部字典，以保持与 Story 8.1 行为一致。
    - `/config list` 与 `/config get` 为只读操作，不得修改任何状态；`/config set` 只负责调用 overrides 层变更运行时配置，不写回 .env，也不改变 .env.example 中的字段含义。
    - 对 TRADING_BACKEND、MARKET_DATA_BACKEND、TRADEBOT_INTERVAL、TRADEBOT_LLM_TEMPERATURE 的值校验必须复用 validate_override_value 或等价逻辑，并在非法取值时返回清晰错误信息，而不是抛出未捕获异常或静默失败。
    - 新增命令 handler 与帮助文案应遵守 notifications/telegram_commands.py 中已有命令的风格与结构（包括 COMMAND_REGISTRY 与 _build_help_message），确保 /help 输出与用户体验保持一致。
    - 所有命令处理中的异常必须被捕获并记录日志，不能影响交易主循环；任何网络或 Telegram API 错误都不应导致进程退出。
    - 本 Story 不负责管理员权限与审计日志实现，但命令设计需要保留 user_id / chat_id 等上下文，方便 Story 8.3 在 handler 层追加权限校验与审计记录。
  </constraints>

  <interfaces>
    - name: TelegramCommandHandler._parse_command_text
      kind: python-staticmethod
      signature: "_parse_command_text(text: str) -&gt; tuple[str, list[str]]"
      path: notifications/telegram_commands.py
    - name: process_telegram_commands
      kind: python-function
      signature: "process_telegram_commands(commands: list[TelegramCommand], command_handlers: Optional[dict[str, Callable[[TelegramCommand], None]]] = None) -&gt; None"
      path: notifications/telegram_commands.py
    - name: set_runtime_override
      kind: python-function
      signature: "set_runtime_override(key: str, value: Any, validate: bool = True) -&gt; tuple[bool, Optional[str]]"
      path: config/runtime_overrides.py
    - name: get_override_whitelist
      kind: python-function
      signature: "get_override_whitelist() -&gt; Set[str]"
      path: config/runtime_overrides.py
    - name: get_effective_trading_backend
      kind: python-function
      signature: "get_effective_trading_backend() -&gt; str"
      path: config/settings.py
    - name: get_effective_market_data_backend
      kind: python-function
      signature: "get_effective_market_data_backend() -&gt; str"
      path: config/settings.py
    - name: get_effective_interval
      kind: python-function
      signature: "get_effective_interval() -&gt; str"
      path: config/settings.py
    - name: get_effective_llm_temperature
      kind: python-function
      signature: "get_effective_llm_temperature() -&gt; float"
      path: config/settings.py
  </interfaces>

  <tests>
    <standards>
      - 遵循 docs/architecture/07-implementation-patterns.md 中关于配置集中在 config/、通知集中在 notifications/、测试集中在 tests/ 的位置模式，以及使用 pytest 风格编写测试。
      - 新增 `/config` 命令相关测试时，应复用 tests/test_notifications_telegram_commands.py 中对命令解析、chat 过滤与错误处理的测试模式，并通过 ./scripts/run_tests.sh 运行全量测试，确保现有测试保持通过。
    </standards>
    <locations>
      - tests/
      - scripts/run_tests.sh
    </locations>
    <ideas>
      - 针对 AC1：为 `/config list` 编写测试，验证在不同 effective 配置组合下能正确返回 4 个白名单 key 及其当前值，并在 Telegram 输出中包含清晰的 key 与说明。
      - 针对 AC2：为 `/config get &lt;KEY&gt;` 编写测试，覆盖合法 key、非法 key、大小写与空格变体，验证当前值与合法取值范围/枚举说明，以及非法 key 时的错误提示与支持 key 列表。
      - 针对 AC3：为 `/config set &lt;KEY&gt; &lt;VALUE&gt;` 编写测试，使用有效与非法 value 覆盖 TRADING_BACKEND、MARKET_DATA_BACKEND、TRADEBOT_INTERVAL、TRADEBOT_LLM_TEMPERATURE，并断言：成功时调用 set_runtime_override 且返回 old/new 值，非法时返回错误文案且不抛出未捕获异常。
      - 为命令调度与未知命令路径编写测试，确保新增 `/config` 不会破坏现有 /kill、/resume、/status、/risk、/reset_daily、/help 行为，并在未知子命令时降级到合适的错误提示或 /help 引导。
    </ideas>
  </tests>
</story-context>
