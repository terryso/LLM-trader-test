 # Story 7.3.2: 实现每日亏损百分比计算

Status: review

 ## Story

As a system,
I want to calculate daily loss percentage in real-time,
so that I can trigger limits when the configured threshold is reached.

## Acceptance Criteria

1. **AC1 – 每日亏损百分比计算函数（与 Epic 7.3 / FR13 对齐）**  
   - 在 `core/risk_control.py` 中实现 `calculate_daily_loss_pct(state: RiskControlState, current_equity: float) -> float` 函数，用于基于当日基准权益计算当日亏损百分比。  
   - 计算公式严格遵循 Epic / PRD 中定义：`(current_equity - daily_start_equity) / daily_start_equity * 100`，其中 `daily_start_equity` 来源于 `RiskControlState.daily_start_equity`。  
   - 函数返回值为当前迭代的当日亏损百分比（正值代表盈利，负值代表亏损），并可被后续 Story 7.3.3/7.3.4 复用。

2. **AC2 – 边界情况处理与状态更新语义**  
   - 当 `state.daily_start_equity` 为 `None`、`0` 或小于 `0` 时：  
     - 函数不得抛出异常；  
     - 应返回 `0.0`，并保持 `state.daily_loss_pct` 处于安全值（例如保留上一轮计算结果或显式设为 `0.0`，具体策略在 Dev Notes 中说明）。  
   - 在 `state.daily_start_equity` 为正数的正常场景下：  
     - 函数计算得到的 `loss_pct` 会写入 `state.daily_loss_pct` 字段；  
     - 返回值与 `state.daily_loss_pct` 一致，便于调用方与日志/通知逻辑使用。  
   - 函数本身不负责触发 Kill-Switch 或修改 `kill_switch_*` 字段，这些逻辑保留给 Story 7.3.3。

3. **AC3 – 与每日基准更新 / 风控流程的一致性（与 Story 7.3.1 / FR12–FR18 对齐）**  
   - `calculate_daily_loss_pct(...)` 设计为与 `update_daily_baseline(...)` 组合使用：  
     - 假定在同一轮迭代中，先由 Story 7.3.1 中的 `update_daily_baseline(state, current_equity)` 维护好 `daily_start_equity` / `daily_start_date`；  
     - 再在需要进行每日亏损检查（例如 Story 7.3.3 的 `check_daily_loss_limit(...)`）时调用 `calculate_daily_loss_pct(...)`。  
   - 本 Story 不改变现有 Kill-Switch（Epic 7.2）或 Daily Loss Limit 触发（Story 7.3.3）的语义，仅提供**计算层能力**：  
     - 不直接依赖环境变量 `DAILY_LOSS_LIMIT_PCT`；  
     - 不在函数内部做阈值比较或 Telegram 通知。  
   - 在 `RISK_CONTROL_ENABLED=False` 时，可以选择：  
     - 由调用方跳过对 `calculate_daily_loss_pct(...)` 的调用；或  
     - 在实现中保证其为幂等、无副作用的 no-op（例如只在 `RISK_CONTROL_ENABLED=True` 时更新 `daily_loss_pct`），二者其一即可，并在 Dev Notes 中记录最终决策。

4. **AC4 – 单元测试覆盖（与 Epic 7.1/7.3 测试标准对齐）**  
   - 在 `tests/test_risk_control.py` 或等价文件中新增测试用例，至少覆盖：  
     - `daily_start_equity` 为正数时，`current_equity` 分别等于、大于、小于基准的场景（盈亏为 0 / 正 / 负）；  
     - `daily_start_equity` 为 `None` 或 `0` 的场景，函数返回 `0.0` 且不抛异常；  
     - 多次调用时，`state.daily_loss_pct` 会随着 `current_equity` 变化而更新，确保结果可重复、可预测。  
   - 测试中无需触发 Kill-Switch 或 Telegram 通知逻辑，仅验证：  
     - 计算公式正确；  
     - 边界条件处理符合 AC2 约定；  
     - `state.daily_loss_pct` 的更新语义清晰可依赖。  
   - 所有新增测试通过 `./scripts/run_tests.sh`，且不破坏现有 Kill-Switch 与每日基准相关测试。

## Tasks / Subtasks

- [x] **Task 1 – 实现每日亏损百分比计算 helper（AC1, AC2）**  
  - [x] 1.1 在 `core/risk_control.py` 中新增 `calculate_daily_loss_pct(state: RiskControlState, current_equity: float) -> float`：  
        - 使用 `RiskControlState.daily_start_equity` 作为当日基准；  
        - 按 `(current_equity - daily_start_equity) / daily_start_equity * 100` 计算 `loss_pct`；  
        - 当 `daily_start_equity` 为 `None`/`0`/负数时返回 `0.0` 并避免除零错误。  
  - [x] 1.2 在正常场景下将计算结果写入 `state.daily_loss_pct`，并返回该值；在边界场景下的 state 更新策略在 Dev Notes 中明确记录（例如是否重置为 `0.0`）。

- [x] **Task 2 – 与每日基准更新 / 后续阈值逻辑的协作约定（AC3）**  
  - [x] 2.1 在 Dev Notes 中明确 `calculate_daily_loss_pct(...)` 与 `update_daily_baseline(...)` 的调用顺序与职责划分：  
        - 前者只负责记录每日基准；后者只负责在给定基准下计算当日亏损百分比；  
        - 两者都不直接修改 Kill-Switch 状态。  
  - [x] 2.2 为后续 Story 7.3.3 (`check_daily_loss_limit(...)`) 预留清晰的对接点：  
        - 建议在 `core/risk_control.py` 中集中封装每日亏损相关逻辑，避免在 `bot.py` 中散落计算代码。  
  - [x] 2.3 明确在 `RISK_CONTROL_ENABLED=False` 时的行为（跳过调用或 no-op），避免出现「风控关闭但仍在更新每日亏损百分比」的隐性副作用。

- [x] **Task 3 – 单元测试与回归验证（AC4）**  
  - [x] 3.1 在 `tests/test_risk_control.py` 中新增 `TestCalculateDailyLossPct` 测试类：  
        - 覆盖盈亏为 0 / 正 / 负、基准为 `None`/`0` 的场景；  
        - 验证 `state.daily_loss_pct` 更新与返回值一致。  
  - [x] 3.2 根据需要在集成测试（例如 `tests/test_risk_control_integration.py`）中为后续 Story 预留断言位置，但本 Story 不强制修改集成测试语义。  
  - [x] 3.3 运行 `./scripts/run_tests.sh`，确保所有新增与既有风控相关测试全部通过。

## Dev Notes

### Requirements & Context Summary

- 本 Story 属于 **Epic 7.3: 每日亏损限制功能** 的第二个实现 Story，对应 `sprint-status.yaml` 中的 key：`7-3-2-实现每日亏损百分比计算`。  
- 需求主要来源：  
  - PRD 《风控系统增强 - 产品需求文档》（`docs/prd-risk-control-enhancement.md`）中「每日亏损限制」相关功能需求：  
    - **FR13** 要求「系统在每次迭代时计算当日权益变化百分比」，本 Story 负责提供这一基础能力；  
    - 与 **FR12 / FR14–FR18** 协同，支撑每日亏损阈值触发与通知等后续 Story；  
  - Epic 文档 `docs/epic-risk-control-enhancement.md` 中 **Story 7.3.2: 实现每日亏损百分比计算** 的详细拆解：  
    - 给出了 `calculate_daily_loss_pct(state, current_equity)` 的推荐函数签名与公式，以及对边界情况和字段更新的要求；  
  - 已完成的 Story 7.3.1（`docs/sprint-artifacts/7-3-1-实现每日起始权益记录.md`）：  
    - 已通过 `update_daily_baseline(...)` 在每个自然日维护 `daily_start_equity` 与 `daily_start_date`，并将相关字段持久化到 `portfolio_state.json.risk_control`。  
- 本 Story 的目标是：在不改变 Kill-Switch 及现有风控语义的前提下，为后续「每日亏损阈值触发」与「每日亏损通知」提供**可复用的每日亏损百分比计算函数**。

### Architecture & Implementation Constraints

- **模块边界与职责分配：**  
  - `core/risk_control.py`：集中维护 `RiskControlState` 结构、每日基准更新 helper（Story 7.3.1）以及本 Story 定义的每日亏损百分比计算 helper（7.3.2），后续还将承载每日亏损阈值检查逻辑（7.3.3）。  
  - `core/state.py` / `core/persistence.py`：继续负责 `RiskControlState` 的加载与保存，本 Story 不直接修改 JSON 结构，仅依赖既有的 `risk_control` 字段。  
  - `bot.py` / 其他调用方：不应自行重复实现每日亏损百分比公式，而是通过 `core.risk_control.calculate_daily_loss_pct(...)` 获取结果。  
- **一致性要求：**  
  - 严格复用 `RiskControlState.daily_start_equity` 作为当日基准，禁止在其他模块维护重复的基准字段；  
  - 本 Story 不引入新的环境变量，不直接读取 `DAILY_LOSS_LIMIT_PCT`，所有阈值判定集中在 Story 7.3.3 中实现；  
  - 不改变 Epic 7.2（Kill-Switch）故事中已定义的信号过滤与状态切换语义，仅为后续阈值触发逻辑提供输入。  
- **禁止事项：**  
  - 禁止在 `strategy/`、`llm/`、`display/` 等非风控核心模块中直接计算或修改每日亏损百分比；  
  - 禁止在本 Story 中向 Telegram 发送任何与每日亏损相关的通知，这属于 Story 7.3.4 的范围；  
  - 禁止在本 Story 中引入对时区的自定义处理逻辑，全部继续复用 Epic 7.3 已确定的「统一使用 UTC」约定。

### Learnings from Previous Story (7-3-1)

- **From Story 7-3-1-实现每日起始权益记录 (Status: done)**  
  - 已存在 `update_daily_baseline(state: RiskControlState, current_equity: float)` helper，用于在每个自然日开始时重置 `daily_start_equity` / `daily_start_date` / `daily_loss_pct` / `daily_loss_triggered`。  
  - `RiskControlState` 及其 `risk_control` 持久化字段已经通过 Story 7.1.x + 7.3.1 的实现与测试验证，在 Bot 重启与跨日场景下具有明确语义。  
  - 本 Story 在实现 `calculate_daily_loss_pct(...)` 时应：  
    - 只依赖 `RiskControlState` 中的字段，不重新引入独立的「每日基准」存储；  
    - 尊重 7-3-1 中对 INFO/DEBUG 日志噪声控制的经验（例如仅在需要时增加调试日志），避免在每轮迭代中额外刷屏。  
  - 后续 Story 7.3.3/7.3.4 在实现每日亏损阈值触发与通知时，应优先复用本 Story 的 helper，而不是内联重新实现公式。

### Project Structure Notes

- 预计主要涉及文件（最终以实际实现为准）：  
  - `core/risk_control.py` —— 新增 `calculate_daily_loss_pct(...)` helper，并在注释/文档字符串中引用 Epic / PRD 对应段落；  
  - `core/state.py` / `core/persistence.py` —— 复用现有 `risk_control` 持久化逻辑，本 Story 不需要增加新字段；  
  - `bot.py` / `core/trading_loop.py` —— 未来在 Story 7.3.3 中调用每日亏损检查逻辑时，通过 `core.risk_control.calculate_daily_loss_pct(...)` 获取结果，而非直接写公式。  
  - `tests/test_risk_control.py` —— 新增 `TestCalculateDailyLossPct` 单元测试类，覆盖正常与边界场景。  
- 项目整体结构参考：`docs/architecture/06-project-structure-and-mapping.md` 与 `docs/architecture/07-implementation-patterns.md`，保持风控逻辑集中在 `core/` 层，并遵循既有的日志与状态管理模式。

### References

- [Source: docs/epic-risk-control-enhancement.md#Story-7.3.2-实现每日亏损百分比计算]  
- [Source: docs/prd-risk-control-enhancement.md#每日亏损限制功能]  
- [Source: docs/epics.md#Epic-7.3-每日亏损限制功能-Post-MVP]  
- [Source: docs/sprint-artifacts/7-3-1-实现每日起始权益记录.md]  
- [Source: docs/architecture/06-project-structure-and-mapping.md]  
- [Source: docs/architecture/07-implementation-patterns.md]

 ## Dev Agent Record

 ### Context Reference

- `docs/sprint-artifacts/7-3-2-实现每日亏损百分比计算.context.xml`  
- (相关) `docs/epic-risk-control-enhancement.md#Story-7.3.2-实现每日亏损百分比计算`  
- (相关) `docs/prd-risk-control-enhancement.md#每日亏损限制功能`

### Agent Model Used

- Cascade（Story 草稿由 SM/AI 协同创建，供后续 Dev Story 实施使用）

### Debug Log References

- **实现决策记录（Task 2.1 - 调用顺序与职责划分）：**
  - `update_daily_baseline(state, current_equity)`: 在每轮迭代开始时调用，负责在 UTC 日期变化时重置 `daily_start_equity` / `daily_start_date` / `daily_loss_pct` / `daily_loss_triggered`。
  - `calculate_daily_loss_pct(state, current_equity)`: 在需要检查每日亏损时调用（通常在 `update_daily_baseline` 之后），负责基于当日基准计算当日亏损百分比并更新 `state.daily_loss_pct`。
  - 两者都不直接修改 Kill-Switch 状态（`kill_switch_active` 等字段），Kill-Switch 触发逻辑保留给 Story 7.3.3 的 `check_daily_loss_limit(...)`。

- **边界情况处理策略（Task 1.2 - AC2）：**
  - 当 `daily_start_equity` 为 `None`、`0` 或负数时，`calculate_daily_loss_pct` 返回 `0.0` 并将 `state.daily_loss_pct` 重置为 `0.0`。
  - 设计理由：在无效基准场景下，将 `daily_loss_pct` 设为安全值 `0.0` 可避免后续阈值检查逻辑误触发，同时保持状态可预测。

- **RISK_CONTROL_ENABLED=False 时的行为（Task 2.3 - AC3）：**
  - `calculate_daily_loss_pct` 本身是纯计算函数，不读取 `RISK_CONTROL_ENABLED` 配置。
  - 在 `RISK_CONTROL_ENABLED=False` 时，由调用方（如 `bot.py` 主循环或 Story 7.3.3 的 `check_daily_loss_limit`）决定是否跳过调用。
  - 即使在风控关闭时调用，函数也是幂等的、无副作用的（仅更新 `state.daily_loss_pct` 字段），不会触发 Kill-Switch 或发送通知。

- **日志级别控制：**
  - `calculate_daily_loss_pct` 仅在 DEBUG 级别输出日志，避免在 INFO 层增加噪声。
  - 当与 Story 7.3.3 集成后，可在触发每日亏损阈值时由阈值检查逻辑统一输出 INFO/WARNING 级别日志与通知。

### Completion Notes List

- **实现完成（2025-11-30）：**
  - 在 `core/risk_control.py` 中新增 `calculate_daily_loss_pct(state, current_equity)` 函数，严格遵循 PRD/Epic 定义的公式。
  - 边界情况处理：当 `daily_start_equity` 为 `None`/`0`/负数时返回 `0.0` 并重置 `state.daily_loss_pct` 为安全值。
  - 函数设计为纯计算层能力，不触发 Kill-Switch、不读取阈值配置、不发送通知，为 Story 7.3.3/7.3.4 提供可复用输入。
  - 新增 15 个单元测试覆盖正常与边界场景，全部 529 个测试通过。

- **与后续 Story 的接口约定：**
  - Story 7.3.3 (`check_daily_loss_limit`) 应调用 `calculate_daily_loss_pct` 获取当日亏损百分比，然后与 `DAILY_LOSS_LIMIT_PCT` 阈值比较。
  - Story 7.3.4 可复用 `state.daily_loss_pct` 字段进行通知格式化。

### File List

- NEW:  
  - （无）  
- MODIFIED:  
  - `core/risk_control.py` — 新增 `calculate_daily_loss_pct` 函数  
  - `core/__init__.py` — 导出 `calculate_daily_loss_pct`  
  - `tests/test_risk_control.py` — 新增 `TestCalculateDailyLossPct` 测试类（15 个测试用例）  
- DELETED:  
  - （无）

### Change Log

- 2025-11-30: Story 7.3.2 实现完成，所有 AC 满足，529 个测试通过
