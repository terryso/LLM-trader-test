# Story 8.3: 权限控制与审计日志

Status: done

## Story

As the owner of the trading system,
I want strict admin-only permissions and audit logs for config changes,
so that sensitive runtime adjustments are controlled and traceable.

## Acceptance Criteria

1. 在配置中支持配置一个管理员 Telegram user_id（或等价机制）。
2. `/config set` 仅在请求方 user_id 匹配管理员配置时才会执行：
   - 非管理员调用时返回「无权限修改，只能查看」提示，不改动任何配置。
3. 每次成功的 `/config set` 调用都会写入日志，至少包括：
   - 时间戳、Telegram user_id、key、old_value、new_value；
   - 日志级别和格式与现有 logging 体系兼容。

## Tasks / Subtasks

- [x] Task 1 – 管理员身份配置与加载（AC1）
  - [x] 1.1 在 `config/settings.py` 中增加管理员 user_id 配置读取（例如 `TELEGRAM_ADMIN_USER_ID`），支持从 `.env` 读取并提供合理默认或显式报错。
  - [x] 1.2 在 `notifications/telegram.py` / `notifications/telegram_commands.py` 中暴露获取当前请求方 user_id 的统一方式，以便权限判断。
- [x] Task 2 – `/config set` 权限控制（AC2）
  - [x] 2.1 在 `/config set` handler 中加入管理员校验逻辑，仅当请求方 user_id 在允许列表内时才继续执行。
  - [x] 2.2 对非管理员调用返回「无权限修改，只能查看」提示，并确保不会调用 `set_runtime_override`。
- [x] Task 3 – 审计日志写入（AC3）
  - [x] 3.1 为每次成功的 `/config set` 调用写入结构化日志，至少包含时间戳、Telegram user_id、key、old_value、new_value。
  - [x] 3.2 审计日志通过现有 logging 体系输出（例如 `notifications/logging.py` 封装），遵循统一日志格式。
- [x] Task 4 – 测试与回归
  - [x] 4.1 为权限控制与审计日志新增测试用例（例如 `tests/test_telegram_config_permissions.py` 或在现有 `test_telegram_config_commands.py` 中扩展）。
  - [x] 4.2 覆盖管理员/非管理员路径、日志内容校验以及与 runtime overrides 的集成行为。
  - [x] 4.3 运行 `./scripts/run_tests.sh`，确保所有测试通过。

## Dev Notes

### Requirements & Context Summary

- 本 Story 属于 **Epic 8: Telegram 远程运营配置管理（Runtime Config Control）** 的第三个实现 Story，对应 `sprint-status.yaml` 中的 key：`8-3-权限控制与审计日志`。
- 需求主要来源：
  - `docs/epics.md` 中 **Story 8.3: 权限控制与审计日志**：
    - 需支持配置单一管理员 Telegram user_id 或等价机制；
    - `/config set` 必须为管理员专属操作；
    - 每次成功的 `/config set` 必须写入结构化审计日志。[Source: docs/epics.md#Story-8.3-权限控制与审计日志]
  - `docs/epics.md` 中 **Epic 8 概述**：
    - Epic 8 强调所有远程配置变更需具备权限校验与可审计性。[Source: docs/epics.md#Epic-8-Telegram-远程运营配置管理-Runtime-Config-Control]
  - `docs/PRD.md` 中 **4.7 Telegram 通知** 与非功能性需求（安全性、可观测性）：
    - 要求通过 Telegram 安全地与运维交互，并确保关键操作可追踪。[Source: docs/PRD.md#4-7-Telegram-通知]

### Architecture & Implementation Constraints

- 模块边界（参考 `docs/architecture/06-project-structure-and-mapping.md` 与 `docs/architecture/07-implementation-patterns.md`）：
  - 权限判断与命令解析集中在 `notifications/telegram_commands.py`；
  - 配置读取集中在 `config/settings.py` / `config/runtime_overrides.py`；
  - 日志输出通过 `notifications/logging.py` 或标准 `logging` 封装。
- 本 Story 不应在配置层引入 Telegram 依赖，避免循环导入：
  - 管理员 user_id 由配置层提供（如 `get_telegram_admin_user_id()`），Telegram 层仅消费该配置。
- 所有审计日志必须遵循统一日志格式，并避免泄露敏感信息（如 API Key）：
  - 日志中仅记录配置 key 与旧/新值的摘要，而非完整 secrets。[Source: docs/architecture/07-implementation-patterns.md#7-7-一致性模式-Consistency-Patterns]

### Project Structure Notes

- 预计主要涉及文件：
  - `config/settings.py` —— 管理员 user_id 配置读取与对外 getter。
  - `notifications/telegram_commands.py` —— 在 `/config set` handler 中接入权限校验与审计日志。
  - `notifications/logging.py` —— 如有需要，新增统一的审计日志 helper。
  - `tests/test_telegram_config_commands.py` 或新建 `tests/test_telegram_config_permissions.py` —— 权限与日志相关测试。
- 应继续遵守：
  - Telegram 命令层只通过 `config` 暴露的 API 访问配置；
  - 不在业务逻辑中直接读取 `os.environ`。

### Learnings from Previous Story

- **前一 Story：** `8-2-telegram-config-命令接口`（状态：`done`，详见 `docs/sprint-artifacts/8-2-telegram-config-命令接口.md`）。
- 可复用能力与约束：
  - `/config` 命令已在 `notifications/telegram_commands.py` 中实现完整的 list/get/set 流程，并预留了 `_record_event` 等 hook，可直接挂接权限与审计逻辑。[Source: docs/sprint-artifacts/8-2-telegram-config-命令接口.md#Dev-Agent-Record]
  - runtime overrides 层已经提供 `set_runtime_override` / `get_override_whitelist` / `validate_override_value` 等 API，本 Story 不应重复校验逻辑，而是在权限通过后调用这些公共接口。[Source: docs/sprint-artifacts/8-2-telegram-config-命令接口.md#Dev-Notes]
  - 8.2 的 Security Notes 已建议在后续 Story 8.3 中为 `/config set` 增加结构化审计日志（时间戳、user_id、key、old_value、new_value）。[Source: docs/sprint-artifacts/8-2-telegram-config-命令接口.md#Security-Notes]
- 对本 Story 的启示：
  - 权限控制与审计实现应尽量复用现有命令分发与日志包装，不引入新的日志后门；
  - 需要特别注意在错误路径（非法 key/value）下也保证不会修改配置，同时保持良好的错误提示。

### References

- [Source: docs/epics.md#Story-8.3-权限控制与审计日志]
- [Source: docs/epics.md#Epic-8-Telegram-远程运营配置管理-Runtime-Config-Control]
- [Source: docs/PRD.md#4-7-Telegram-通知]
- [Source: docs/architecture/06-project-structure-and-mapping.md]
- [Source: docs/architecture/07-implementation-patterns.md]
- [Source: docs/sprint-artifacts/8-2-telegram-config-命令接口.md#Dev-Agent-Record]

## Dev Agent Record

### Context Reference

- Story Context XML 将在运行 `story-context` 工作流时生成，并放置于：`docs/sprint-artifacts/8-3-权限控制与审计日志.context.xml`（预期路径）。
- docs/sprint-artifacts/8-3-权限控制与审计日志.context.xml

### Agent Model Used

Cascade

### Debug Log References

- 权限校验入口：`_check_admin_permission()` 函数
- 审计日志入口：`_log_config_audit()` 函数
- 权限拒绝日志：`handle_config_set_command()` 中的 WARNING 级别日志

### Completion Notes List

- [x] 初始 Story 草稿由 `/create-story` 工作流基于 PRD / Epic / 架构文档与前一 Story 8.2 的 Dev Notes 生成。
- [x] Task 1: 在 `config/settings.py` 中添加 `TELEGRAM_ADMIN_USER_ID` 配置和 `get_telegram_admin_user_id()` getter 函数。
- [x] Task 1.2: 在 `TelegramCommand` 数据类中添加 `user_id` 字段，并在 `_parse_update()` 中从 Telegram 消息的 `from` 字段提取。
- [x] Task 2: 在 `handle_config_set_command()` 中添加 `_check_admin_permission()` 权限校验，非管理员返回「无权限修改，只能查看」提示。
- [x] Task 3: 添加 `_log_config_audit()` 函数，为成功的配置变更写入结构化审计日志（WARNING 级别），包含 timestamp、user_id、chat_id、key、old_value、new_value、success 字段。
- [x] Task 4: 在 `tests/test_telegram_config_commands.py` 中扩展测试，新增 `TestAdminUserIdConfiguration`、`TestCheckAdminPermission`、`TestConfigSetPermissionControl`、`TestConfigAuditLogging`、`TestLogConfigAuditHelper`、`TestConfigPermissionIntegration` 等测试类，共 788 个测试全部通过。

### File List

- `config/settings.py` — 新增 `TELEGRAM_ADMIN_USER_ID` 配置和 `get_telegram_admin_user_id()` getter
- `notifications/telegram_commands.py` — 新增 `user_id` 字段、`_check_admin_permission()`、`_log_config_audit()` 函数，修改 `handle_config_set_command()` 添加权限校验和审计日志
- `tests/test_telegram_config_commands.py` — 扩展测试覆盖权限控制和审计日志
- `.env.example` — 新增 `TELEGRAM_ADMIN_USER_ID` 配置说明
- `docs/sprint-artifacts/8-3-权限控制与审计日志.md` — Story 文档

## Change Log

- 2025-12-01: 初始 Story 草稿由 `/create-story` 工作流创建，状态设为 `drafted`。
- 2025-12-01: 完成所有 Task 实现，状态更新为 `review`。

- 2025-12-02: 完成 Senior Developer Review (AI)，结论：Approve，状态更新为 `done`。

## Senior Developer Review (AI)

### Reviewer
- Nick (AI Senior Developer)

### Date
- 2025-12-02

### Outcome
- Approve（通过）

### Summary
- 实现为 `/config set` 引入了严格的管理员权限控制：仅当 Telegram `user_id` 与配置的 `TELEGRAM_ADMIN_USER_ID` 匹配时才允许修改运行时配置。
- 非管理员请求会被明确拒绝，并返回「无权限修改，只能查看」提示，不会调用 `set_runtime_override`，保证运行时配置不会被越权修改。
- 每次成功的 `/config set` 调用都会通过现有 logging 体系写入结构化审计日志，包含时间戳、user_id、key、old_value、new_value、chat_id 等字段，满足可追踪性与安全审计要求。
- 新增测试系统性覆盖了管理员/非管理员路径、非法 key/value、审计日志内容以及与 runtime overrides 集成行为，`./scripts/run_tests.sh` 全量通过（788 tests）。
- 实现遵守架构分层约束：权限配置留在 `config/`，权限判断与审计逻辑集中在 `notifications/telegram_commands.py`，未引入循环依赖或越层访问。

### Key Findings

**High Severity**
- 无。

**Medium Severity**
- 无。

**Low Severity**
- `/help` 输出中的命令说明目前仍将 `/config set KEY VALUE` 描述为「修改运行时配置」，未显式标注「仅限管理员」，可能导致普通用户误以为自己可以修改配置（易用性与认知风险，非安全漏洞）。

---

### Acceptance Criteria Coverage

| AC  | 描述 | 状态 | 证据 |
| --- | ---- | ---- | ---- |
| AC1 | 支持配置管理员 Telegram user_id 用于权限判断 | IMPLEMENTED | `config/settings.py:369-377, 743-757`（读取 `TELEGRAM_ADMIN_USER_ID` 并提供 `get_telegram_admin_user_id()`）、`.env.example:51-62`（文档与示例配置）、`tests/test_telegram_config_commands.py:503-525`（getter 行为测试） |
| AC2 | `/config set` 仅在请求方 user_id 匹配管理员配置时执行；非管理员返回「无权限修改，只能查看」，且不修改配置 | IMPLEMENTED | `notifications/telegram_commands.py:28-47, 210-269`（在 `TelegramCommand` 中引入 `user_id` 并从 Telegram `from.id` 提取）、`notifications/telegram_commands.py:1316-1340, 1434-1470`（`_check_admin_permission()` 与权限拒绝分支）、`notifications/telegram_commands.py:1472-1543`（仅在权限通过后才验证并写入 overrides）、`tests/test_telegram_config_commands.py:531-599, 602-627`（管理员/非管理员/未配置管理员场景与只读命令场景测试） |
| AC3 | 每次成功的 `/config set` 调用写入结构化日志，包含时间戳、user_id、key、old_value、new_value，兼容现有 logging 体系 | IMPLEMENTED | `notifications/telegram_commands.py:1343-1386`（`_log_config_audit()` 使用 `logging.warning` 输出 `CONFIG_AUDIT` 记录）、`notifications/telegram_commands.py:1564-1586`（仅在 `set_runtime_override` 成功后调用 `_log_config_audit()`）、`tests/test_telegram_config_commands.py:650-735`（验证日志中包含 timestamp/user_id/key/old_value/new_value 字段，且在失败或权限不足时不写审计日志） |

**AC 覆盖总结：** 3/3 条 Acceptance Criteria 均有明确实现与测试验证，未发现缺失或部分实现的情况。

---

### Task Completion Validation

| Task / Subtask | 标记状态 | 验证状态 | 证据 |
| -------------- | -------- | -------- | ---- |
| Task 1 – 管理员身份配置与加载 | [x] | VERIFIED COMPLETE | `config/settings.py:369-377` 新增 `TELEGRAM_ADMIN_USER_ID`，`config/settings.py:743-757` 实现 `get_telegram_admin_user_id()`，`.env.example:51-62` 提供示例与文档；`tests/test_telegram_config_commands.py:503-525` 覆盖 getter 行为 |
| 1.1 在 `config/settings.py` 中增加管理员 user_id 配置读取 | [x] | VERIFIED COMPLETE | 同上，读取 `.env` 并通过 getter 暴露；未引入对 `notifications` 的反向依赖 |
| 1.2 在 Telegram 层暴露请求方 user_id | [x] | VERIFIED COMPLETE | `notifications/telegram_commands.py:28-47` 为 `TelegramCommand` 增加 `user_id` 字段，`notifications/telegram_commands.py:257-259` 从 Telegram `message.from.id` 提取 user_id；`tests/test_telegram_config_commands.py:51-61` 通过构造命令对象模拟 user_id |
| Task 2 – `/config set` 权限控制 | [x] | VERIFIED COMPLETE | `notifications/telegram_commands.py:1316-1340, 1434-1470` 权限校验与拒绝逻辑，`tests/test_telegram_config_commands.py:572-615` 覆盖管理员/非管理员/未配置管理员分支 |
| 2.1 在 `/config set` handler 中加入管理员校验逻辑 | [x] | VERIFIED COMPLETE | `notifications/telegram_commands.py:1434-1470` 进入 set 逻辑前统一调用 `_check_admin_permission()`，并在权限失败时提前返回 |
| 2.2 非管理员返回「无权限修改，只能查看」，且不调用 `set_runtime_override` | [x] | VERIFIED COMPLETE | 拒绝分支仅构造消息并返回 `CommandResult`，`set_runtime_override` 调用在权限通过之后；`tests/test_telegram_config_commands.py:587-599` 断言覆盖 runtime override 未被修改且消息中包含「无权限」提示 |
| Task 3 – 审计日志写入 | [x] | VERIFIED COMPLETE | `_log_config_audit()` 与 `handle_config_set_command()` 成功路径集成；`tests/test_telegram_config_commands.py:650-735` 验证写入/不写入审计日志的条件以及日志内容 |
| 3.1 为每次成功的 `/config set` 写入结构化日志 | [x] | VERIFIED COMPLETE | `notifications/telegram_commands.py:1579-1586` 仅在成功完成 override 更新后调用 `_log_config_audit()`；日志包含 timestamp/user_id/chat_id/key/old_value/new_value/success |
| 3.2 审计日志通过现有 logging 体系输出 | [x] | VERIFIED COMPLETE | 使用标准 `logging.warning`，未引入独立日志通道；格式遵守架构中统一前缀模式，方便 grep 与集中采集 |
| Task 4 – 测试与回归 | [x] | VERIFIED COMPLETE | `tests/test_telegram_config_commands.py` 新增多组测试用例；`./scripts/run_tests.sh` 执行结果为 788/788 通过（见 Dev Notes 记录） |
| 4.1 新增权限控制与审计日志测试用例 | [x] | VERIFIED COMPLETE | `tests/test_telegram_config_commands.py:500-857` 中新增的多个测试类覆盖 AC1–AC3 及边界条件 |
| 4.2 覆盖管理员/非管理员路径、日志内容校验、与 runtime overrides 集成 | [x] | VERIFIED COMPLETE | 参见 `TestConfigSetPermissionControl`、`TestConfigAuditLogging`、`TestConfigPermissionIntegration` 中的断言 |
| 4.3 运行 `./scripts/run_tests.sh` 并确保通过 | [x] | VERIFIED COMPLETE | 本次执行结果：`788 passed in 11.25s`，无新增回归 |

**任务校验总结：** 所有标记为 [x] 的 Task 与 Subtask 均能在代码与测试中找到对应实现与证据；未发现「已勾选但未实现」的情况。

---

### Test Coverage and Gaps

- 权限配置与加载测试：`TestAdminUserIdConfiguration` 验证 `get_telegram_admin_user_id()` 在配置存在、缺失以及包含空白符时的行为。
- 管理员 / 非管理员权限路径测试：`TestCheckAdminPermission` 与 `TestConfigSetPermissionControl` 系统性覆盖管理员、非管理员以及未配置管理员场景。
- 审计日志测试：`TestConfigAuditLogging` 验证成功调用会写入 `CONFIG_AUDIT` 记录，失败与越权场景不会写入。
- runtime overrides 集成测试：`TestConfigSetUsesRuntimeOverridesAPI` 与 `TestConfigCommandIntegration` 验证 `/config set` 仅通过 runtime overrides API 修改配置，不直接修改环境变量。
- 回归测试：`./scripts/run_tests.sh` 全量通过，说明本 Story 未破坏既有行为。

---

### Architectural Alignment

- 分层与依赖方向：
  - 管理员配置与 getter 保持在 `config/settings.py`，仅暴露 `get_telegram_admin_user_id()`，未引入对 `notifications` 的反向依赖。
  - 权限与命令解析集中在 `notifications/telegram_commands.py`，符合 7.2 与 7.6 的位置与分层约定。
- 日志与审计：
  - 审计日志使用标准 `logging`，未引入新的日志通道，满足 7.7 日志一致性约定。
  - 日志内容不包含 API Key 等敏感信息，仅记录配置 key 与值的摘要。
- 配置与文档：
  - 新增的 `TELEGRAM_ADMIN_USER_ID` 在 `.env.example` 与 Story Dev Notes 中均有说明，符合 7.6 中「新增配置项需同时更新 `.env.example` 与文档」的约定。

---

### Security Notes

- `/config set` 作为高风险操作，现已通过单一管理员 user_id 控制，默认情况下（未配置管理员）所有修改请求均被拒绝（fail-safe）。
- 审计日志为每次成功的配置变更记录了必要上下文信息（时间戳、user_id、key、old_value、new_value、chat_id），便于追踪与事后审计。
- 日志中只记录配置 key 与值的摘要，未暴露任何 API Key 或密钥类敏感信息。
- 若未来引入多管理员或角色体系，可在架构层补充相应设计，并在权限判断处保持同样的集中化与可审计性。

---

### Best-Practices and References

- 参照 `docs/architecture/07-implementation-patterns.md` 中的分层、日志与配置约定，实现将：
  - 配置读取集中在 `config/`；
  - 权限与命令解析集中在 `notifications/`；
  - 测试集中在 `tests/`，并采用 pytest 风格。
- 权限控制逻辑封装为 `_check_admin_permission()`，审计逻辑封装为 `_log_config_audit()`，有利于未来扩展与复用（例如在其它敏感命令中重用同一模式）。

---

### Action Items

**Code Changes Required**

- [ ] [Low] 在 `/help` 输出中更新 `/config set KEY VALUE` 的描述，显式标注「仅限管理员使用」，以减少普通用户的认知偏差。
  - 建议：在 `notifications/telegram_commands.py:383-393` 的 `COMMAND_REGISTRY` 中，将 `/config set` 描述调整为类似「（仅管理员）修改运行时配置」。

**Advisory Notes (No Immediate Code Change Required)**

- Note: 如未来引入多管理员或角色（Ops / SRE）分工，可考虑将 `TELEGRAM_ADMIN_USER_ID` 扩展为允许多个 ID 或基于配置文件的 ACL 列表，并在 Story/Epic 级别补充相应需求与验收标准。

