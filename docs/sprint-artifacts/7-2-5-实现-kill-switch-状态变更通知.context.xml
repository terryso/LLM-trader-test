<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>7.2</epicId>
    <storyId>5</storyId>
    <title>实现 Kill-Switch 状态变更通知</title>
    <status>drafted</status>
    <generatedAt>2025-11-30T21:20:00+08:00</generatedAt>
    <generator>BMAD Story Context Workflow (manual agent execution)</generator>
    <sourceStoryPath>docs/sprint-artifacts/7-2-5-实现-kill-switch-状态变更通知.md</sourceStoryPath>
  </metadata>

  <story>
    <asA><![CDATA[As a user]]></asA>
    <iWant><![CDATA[I want to receive Telegram notifications when Kill-Switch status changes]]></iWant>
    <soThat><![CDATA[so that I'm aware of risk control events and can react quickly to risk control actions.]]></soThat>
    <tasks><![CDATA[
- [ ] **Task 1 – 设计 Kill-Switch 通知 API（AC1, AC2, AC3）**  
  - [ ] 1.1 复查 `core/risk_control.py` 中 Kill-Switch 生命周期（`activate_kill_switch` / `deactivate_kill_switch` 等）以及调用点，确定挂接通知的单一入口。  
  - [ ] 1.2 设计并实现 Kill-Switch 通知 helper（例如放在 `notifications/telegram.py` 或新的 `notifications/risk_control_notifications.py` 中）：  
        - 提供 `notify_kill_switch_activated(reason: str, positions_count: int, ...)` 与 `notify_kill_switch_deactivated(..., ...)` 等函数；  
        - 内部组装 Markdown 文本，外部通过注入 send 函数或配置调用 `send_telegram_message(...)`。  
  - [ ] 1.3 明确从何处获取 `bot_token` / `chat_id` / 关注的持仓数量等信息（对应模块可能是 `config/settings.py`、`notifications/telegram.py`、`core/state.py` 等），在 Dev Notes 中记录最终决策。

- [ ] **Task 2 – 集成通知到 Kill-Switch 状态变更路径（AC1, AC2, AC4）**  
  - [ ] 2.1 在 Kill-Switch 激活/解除逻辑中调用通知 helper，并确保仅在状态真正发生变化时触发（例如通过比较旧状态与新状态）。  
  - [ ] 2.2 确保由每日亏损限制等间接途径触发 Kill-Switch 时，同样能够走到统一的通知逻辑（避免多处复制）。  
  - [ ] 2.3 为相关路径补充或更新结构化日志，保持与已有 Kill-Switch 日志、`ai_decisions.csv` 风控审计记录风格一致。

- [ ] **Task 3 – 单元测试与回归验证（AC3, AC4）**  
  - [ ] 3.1 为通知 helper 编写单元测试，使用 stub 的 `send_fn` 捕获文本内容与参数，验证激活/解除两类消息的字段与格式。  
  - [ ] 3.2 为 Kill-Switch 生命周期添加或扩展测试（例如在 `tests/test_risk_control_integration.py` 或新的 `tests/test_notifications_telegram.py` 中），验证：  
        - 状态从 False→True / True→False 时会调用通知逻辑；  
        - 状态保持不变时不会重复触发通知。  
  - [ ] 3.3 运行 `./scripts/run_tests.sh`，确保所有现有 Kill-Switch / 风控 / Telegram 相关测试继续通过，如有必要，仅在期望值层面调整新增日志或调用次数。
    ]]></tasks>
  </story>

  <acceptanceCriteria><![CDATA[
1. AC1 – Kill-Switch 激活时发送结构化通知（PRD FR11, FR19 对齐）
2. AC2 – Kill-Switch 解除时发送确认通知（PRD FR11 对齐）
3. AC3 – 通知内容符合 Telegram Markdown 规范且与现有模块对齐
4. AC4 – 日志与测试覆盖（与 FR19/FR20、一致性要求对齐）

（完整文本请参考 Story 文件，对 AC 的实现和验证必须与 Story 完整版本严格对齐，不得增减条目。）
]]></acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd-risk-control-enhancement.md</path>
        <title>风控系统增强 - 产品需求文档</title>
        <section>Kill-Switch 功能 / 日志与审计</section>
        <snippet>定义了 Kill-Switch 激活与解除时的预期行为语义，并要求在状态变更时发送 Telegram 通知以及记录结构化日志和 ai_decisions.csv 审计记录（FR5–FR11, FR19–FR20）。</snippet>
      </doc>
      <doc>
        <path>docs/epic-risk-control-enhancement.md</path>
        <title>风控系统增强 - Epic 与 Story 分解</title>
        <section>Epic 7.2 / Story 7.2.5</section>
        <snippet>将本 Story 明确为 Kill-Switch 状态变更（激活/解除）时的 Telegram 通知能力，要求消息包含原因、时间、持仓数量以及恢复指令提示，并具备单元测试覆盖。</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>LLM-trader-test - Epic Breakdown</title>
        <section>Epic 7: 风控系统增强（Emergency Controls）</section>
        <snippet>在高层概述中说明 Epic 7 覆盖 Kill-Switch、每日亏损限制与 Telegram 命令等能力，本 Story 属于 Epic 7.2 Kill-Switch 核心功能链路中的通知部分。</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/7-2-3-实现信号过滤逻辑.md</path>
        <title>Story 7.2.3: 实现信号过滤逻辑</title>
        <section>Dev Notes / Learnings</section>
        <snippet>确认 Kill-Switch 与其他风控结果通过 allow_entry 在 process_ai_decisions 中统一过滤 entry，并在 ai_decisions.csv 中记录风控阻止事件，为通知 Story 提供前序行为与审计链条。</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/7-2-4-确保-sl-tp-在-kill-switch-期间正常工作.md</path>
        <title>Story 7.2.4: 确保 SL/TP 在 Kill-Switch 期间正常工作</title>
        <section>Dev Notes / Learnings</section>
        <snippet>验证 Kill-Switch 激活期间 SL/TP 与 close 路径仍然工作良好，仅 entry 被阻止，为本 Story 中在状态变更时报告风险收缩/暂停行为提供语义基础。</snippet>
      </doc>
      <doc>
        <path>docs/architecture/03-data-flow.md</path>
        <title>架构分片：数据流</title>
        <section>3.1 实时交易路径 / 通知与显示阶段</section>
        <snippet>展示从主循环到执行层再到通知/仪表盘的完整数据流，指出 Telegram 通知位于状态持久化之后、仪表盘之前，是 Kill-Switch 状态变更消息的自然落点。</snippet>
      </doc>
      <doc>
        <path>docs/architecture/06-project-structure-and-mapping.md</path>
        <title>架构分片：项目结构与映射</title>
        <section>6.2 PRD 功能块到架构组件的映射</section>
        <snippet>将 Telegram 通知能力映射到 notifications/telegram.py 与 display/formatters.py，说明 Kill-Switch 相关通知也应复用这一通知层，而不是在业务逻辑中散落裸请求。</snippet>
      </doc>
      <doc>
        <path>docs/architecture/07-implementation-patterns.md</path>
        <title>架构分片：实现模式与一致性规则</title>
        <section>7.3 数据与格式模式 / 7.5 生命周期与错误处理模式 / 7.8 测试与校验模式</section>
        <snippet>定义了统一的日志格式、时间/时区、错误处理与测试策略，要求外部服务（包括 Telegram）通过专门函数封装并具备完备测试，本 Story 的通知设计需遵循这些约定。</snippet>
      </doc>
    </docs>

    <code>
      <codeArtifact>
        <path>core/risk_control.py</path>
        <kind>risk-control</kind>
        <symbol>activate_kill_switch / deactivate_kill_switch / apply_kill_switch_env_override</symbol>
        <lines>128-274</lines>
        <reason>实现 Kill-Switch 激活与解除的核心生命周期以及环境变量优先级逻辑，是挂接状态变更通知、构造触发原因字符串的唯一权威入口。</reason>
      </codeArtifact>
      <codeArtifact>
        <path>core/state.py</path>
        <kind>state-management</kind>
        <symbol>load_state / save_state / risk_control_state</symbol>
        <lines>68-155</lines>
        <reason>负责从 portfolio_state.json 加载并保存 RiskControlState，同时维护全局 positions 字典，为通知中引用当前持仓数量与跨重启保持 Kill-Switch 状态提供基础。</reason>
      </codeArtifact>
      <codeArtifact>
        <path>notifications/telegram.py</path>
        <kind>notifications</kind>
        <symbol>send_telegram_message / send_entry_signal_to_telegram / send_close_signal_to_telegram</symbol>
        <lines>24-185</lines>
        <reason>封装 Telegram Bot API 的发送逻辑以及 Markdown 转义和降级策略，本 Story 计划新增的 Kill-Switch 通知 helper 应复用该模块并遵循现有错误处理模式。</reason>
      </codeArtifact>
      <codeArtifact>
        <path>docs/sprint-artifacts/7-2-3-实现信号过滤逻辑.context.xml</path>
        <kind>story-context</kind>
        <symbol>Story 7.2.3 Context</symbol>
        <lines>1-210</lines>
        <reason>现有 Kill-Switch 信号过滤 Story 的上下文文件，列出了 check_risk_limits、process_ai_decisions 与 executor 守卫的接口和测试位置，为本 Story 进一步扩展通知能力提供参考。</reason>
      </codeArtifact>
      <codeArtifact>
        <path>docs/sprint-artifacts/7-2-4-确保-sl-tp-在-kill-switch-期间正常工作.context.xml</path>
        <kind>story-context</kind>
        <symbol>Story 7.2.4 Context</symbol>
        <lines>1-216</lines>
        <reason>前一 Story 的上下文文件，详细说明 Kill-Switch 与 SL/TP 的边界、相关代码与测试位置，本 Story 的通知行为需要与这些语义保持一致。</reason>
      </codeArtifact>
      <codeArtifact>
        <path>tests/test_risk_control_integration.py</path>
        <kind>tests</kind>
        <symbol>RiskControlPersistenceIntegrationTests / KillSwitchEnvOverrideIntegrationTests 等</symbol>
        <lines>29-575</lines>
        <reason>覆盖 RiskControlState 持久化、KILL_SWITCH 环境变量优先级以及 Kill-Switch 激活/解除行为，是为状态变更通知新增集成测试的主要落点。</reason>
      </codeArtifact>
    </code>

    <dependencies>
      <dependency ecosystem="python" name="pandas" version="2.2.3" />
      <dependency ecosystem="python" name="numpy" version="2.1.3" />
      <dependency ecosystem="python" name="requests" version="2.31.0" />
      <dependency ecosystem="python" name="python-binance" version="1.0.19" />
      <dependency ecosystem="python" name="hyperliquid-python-sdk" version=">=0.9.0" />
      <dependency ecosystem="python" name="ccxt" version="(unspecified)" />
      <dependency ecosystem="python" name="colorama" version="0.4.6" />
      <dependency ecosystem="python" name="streamlit" version="1.38.0" />
    </dependencies>
  </artifacts>

  <constraints><![CDATA[
- Kill-Switch 状态的变更（激活/解除）必须继续通过 core.risk_control 和 core.state 维护的 RiskControlState 作为单一真源，通知层不得自行缓存或推断第二套状态。
- 新增的通知逻辑必须复用 notifications/telegram.py 中现有的 send_telegram_message 与 Markdown 转义/降级策略，禁止在业务代码中直接发起裸 HTTP 请求。
- Telegram 通知失败（网络错误或 Markdown 解析错误）不得影响主循环与风控逻辑执行，只能通过结构化日志记录错误，保持当前迭代继续进行。
- 为避免「通知风暴」，必须在 Kill-Switch 状态真正发生变化（False→True / True→False）时才发送通知，重复调用激活/解除逻辑时不得重复发送相同事件。
]]></constraints>

  <interfaces>
    <interface>
      <name>activate_kill_switch</name>
      <kind>function</kind>
      <signature>activate_kill_switch(state: RiskControlState, reason: str, triggered_at: Optional[datetime] = None) -&gt; RiskControlState</signature>
      <path>core/risk_control.py</path>
    </interface>
    <interface>
      <name>deactivate_kill_switch</name>
      <kind>function</kind>
      <signature>deactivate_kill_switch(state: RiskControlState, reason: str = &quot;runtime:resume&quot;, total_equity: Optional[float] = None) -&gt; RiskControlState</signature>
      <path>core/risk_control.py</path>
    </interface>
    <interface>
      <name>apply_kill_switch_env_override</name>
      <kind>function</kind>
      <signature>apply_kill_switch_env_override(state: RiskControlState, kill_switch_env: Optional[str] = None) -&gt; Tuple[RiskControlState, bool]</signature>
      <path>core/risk_control.py</path>
    </interface>
    <interface>
      <name>send_telegram_message</name>
      <kind>function</kind>
      <signature>send_telegram_message(*, bot_token: str, default_chat_id: str, text: str, chat_id: Optional[str] = None, parse_mode: Optional[str] = &quot;Markdown&quot;) -&gt; None</signature>
      <path>notifications/telegram.py</path>
    </interface>
  </interfaces>

  <tests>
    <standards><![CDATA[
- 使用 pytest 作为测试框架，所有测试位于 tests/ 目录下，文件命名为 test_*.py。
- 风控与 Kill-Switch 相关测试需覆盖：状态持久化、环境变量优先级、信号过滤以及本 Story 引入的状态变更通知行为，保持既有测试全部通过。
- 针对通知逻辑推荐使用 stub/mocking 注入 send 函数与日志捕获（caplog），在不触发真实 Telegram 请求的前提下验证消息内容与错误处理路径。
]]></standards>
    <locations><![CDATA[
- tests/test_risk_control_integration.py
- tests/test_stop_loss_take_profit.py
- tests/test_notifications_telegram.py （建议新增，用于集中验证通知 helper 行为）
- 其他功能相关测试文件（根据需要扩展），统一位于 tests/ 目录。
]]></locations>
    <ideas><![CDATA[
- AC1：为 activate_kill_switch / apply_kill_switch_env_override 构造从 inactive→active 的状态转移，注入假 positions 和 stub send_fn，验证触发一次带有原因、UTC 时间和持仓数量的 Kill-Switch 激活通知。
- AC2：为 deactivate_kill_switch 构造从 active→inactive 的状态转移，验证发送一次解除通知；在 Kill-Switch 已经为 inactive 的情况下多次调用不会重复发送（幂等性）。
- AC3：在 Telegram 配置缺失（bot token 或 chat id 为空）时调用通知 helper，断言不会抛出异常、不触发真实发送，但会记录一条说明原因的 INFO/WARNING 日志。
- AC4：在集成测试中通过 load_state / save_state 模拟带有 Kill-Switch 的重启场景，验证在状态从持久化 inactive→运行时 active 或反向变化时仅触发一次通知，并保持既有风控与 SL/TP 测试全部通过（通过 ./scripts/run_tests.sh 验证）。
]]></ideas>
  </tests>
</story-context>
