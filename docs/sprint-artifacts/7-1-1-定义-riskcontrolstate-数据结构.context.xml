<story-context id="7-1-1-定义-riskcontrolstate-数据结构" v="1.0">
  <metadata>
    <epicId>7.1</epicId>
    <storyId>7.1.1</storyId>
    <title>定义 RiskControlState 数据结构</title>
    <status>drafted</status>
    <generatedAt>2025-11-30</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/7-1-1-定义-riskcontrolstate-数据结构.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>a well-defined data structure for risk control state</iWant>
    <soThat>all risk control features have a consistent state model</soThat>
    <tasks>
      <task id="1" ac="1">
        <title>创建 core/risk_control.py 模块</title>
        <subtasks>
          <subtask id="1.1">创建文件 core/risk_control.py</subtask>
          <subtask id="1.2">添加模块文档字符串</subtask>
          <subtask id="1.3">更新 core/__init__.py 导出新模块</subtask>
        </subtasks>
      </task>
      <task id="2" ac="2">
        <title>实现 RiskControlState dataclass</title>
        <subtasks>
          <subtask id="2.1">导入必要依赖 (dataclasses, typing)</subtask>
          <subtask id="2.2">定义 dataclass 及所有字段</subtask>
          <subtask id="2.3">添加字段文档字符串</subtask>
        </subtasks>
      </task>
      <task id="3" ac="3">
        <title>实现序列化方法 to_dict()</title>
        <subtasks>
          <subtask id="3.1">使用 dataclasses.asdict() 实现</subtask>
          <subtask id="3.2">确保返回值可被 json.dumps() 处理</subtask>
        </subtasks>
      </task>
      <task id="4" ac="4,5">
        <title>实现反序列化方法 from_dict()</title>
        <subtasks>
          <subtask id="4.1">实现 @classmethod from_dict()</subtask>
          <subtask id="4.2">使用 .get() 方法处理缺失字段</subtask>
          <subtask id="4.3">为每个字段提供合理默认值</subtask>
        </subtasks>
      </task>
      <task id="5" ac="6">
        <title>添加单元测试</title>
        <subtasks>
          <subtask id="5.1">创建 tests/test_risk_control.py</subtask>
          <subtask id="5.2">测试默认值初始化</subtask>
          <subtask id="5.3">测试 to_dict() 序列化</subtask>
          <subtask id="5.4">测试 from_dict() 反序列化</subtask>
          <subtask id="5.5">测试缺失字段处理</subtask>
          <subtask id="5.6">运行测试确保通过</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">core/risk_control.py 模块存在且可导入</criterion>
    <criterion id="AC2">RiskControlState dataclass 包含以下字段：kill_switch_active (bool), kill_switch_reason (Optional[str]), kill_switch_triggered_at (Optional[str]), daily_start_equity (Optional[float]), daily_start_date (Optional[str]), daily_loss_pct (float), daily_loss_triggered (bool)</criterion>
    <criterion id="AC3">to_dict() 方法返回可 JSON 序列化的字典</criterion>
    <criterion id="AC4">from_dict() 类方法可从字典正确恢复状态</criterion>
    <criterion id="AC5">缺失字段时使用合理默认值（不抛出异常）</criterion>
    <criterion id="AC6">添加单元测试覆盖所有公共方法</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-7-1.md</path>
        <title>Epic 技术规格: 风控状态管理基础设施</title>
        <section>Data Models and Contracts</section>
        <snippet>定义 RiskControlState dataclass 结构，包含 7 个字段，实现 to_dict() 和 from_dict() 方法用于序列化。</snippet>
      </doc>
      <doc>
        <path>docs/epic-risk-control-enhancement.md</path>
        <title>风控系统增强 - Epic 与 Story 分解</title>
        <section>Story 7.1.1</section>
        <snippet>定义 RiskControlState dataclass，包含 kill_switch 和 daily_loss 相关字段，实现序列化方法。</snippet>
      </doc>
      <doc>
        <path>docs/prd-risk-control-enhancement.md</path>
        <title>风控系统增强 - 产品需求文档</title>
        <section>技术设计要点</section>
        <snippet>RiskControlState 数据结构定义，包含 Kill-Switch 状态、每日亏损状态等字段。</snippet>
      </doc>
      <doc>
        <path>docs/architecture/07-implementation-patterns.md</path>
        <title>实现模式与一致性规则</title>
        <section>7.2 目录与代码结构</section>
        <snippet>core/ 层包含核心业务逻辑，新模块应遵循现有命名规范和模块结构。</snippet>
      </doc>
      <doc>
        <path>docs/architecture/02-components.md</path>
        <title>组件视图</title>
        <section>2.2 核心业务层</section>
        <snippet>core/ 层包含 state.py、persistence.py、metrics.py 等模块，新增 risk_control.py 应遵循相同模式。</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>core/__init__.py</path>
        <kind>module-init</kind>
        <symbol>__all__</symbol>
        <lines>1-114</lines>
        <reason>需要更新此文件以导出新的 risk_control 模块</reason>
      </file>
      <file>
        <path>core/state.py</path>
        <kind>module</kind>
        <symbol>RiskControlState 参考模式</symbol>
        <lines>1-50</lines>
        <reason>参考现有状态管理模式，包括全局变量、getter/setter 函数设计</reason>
      </file>
      <file>
        <path>core/persistence.py</path>
        <kind>module</kind>
        <symbol>load_state_from_json, save_state_to_json</symbol>
        <lines>128-208</lines>
        <reason>参考 JSON 序列化/反序列化模式，后续 Story 将扩展此模块</reason>
      </file>
      <file>
        <path>tests/test_core_persistence.py</path>
        <kind>test</kind>
        <symbol>TestLoadStateFromJson</symbol>
        <lines>1-70</lines>
        <reason>参考现有测试模式，使用 pytest、tmp_path fixture、class-based 测试组织</reason>
      </file>
    </code>

    <dependencies>
      <python>
        <package name="dataclasses" version="stdlib">Python 标准库，用于定义 dataclass</package>
        <package name="typing" version="stdlib">Python 标准库，用于类型注解</package>
        <package name="pytest" version="dev">测试框架</package>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">新模块位于 core/risk_control.py，遵循 core/ 层组件模式</constraint>
    <constraint type="dependency">仅使用 Python 标准库，无新增外部依赖</constraint>
    <constraint type="naming">遵循 PEP 8：snake_case 函数名，PascalCase 类名</constraint>
    <constraint type="compatibility">dataclass 需支持 Python 3.10+</constraint>
    <constraint type="serialization">to_dict() 返回值必须可被 json.dumps() 处理</constraint>
    <constraint type="backward-compat">from_dict() 必须处理缺失字段，不抛出异常</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>RiskControlState</name>
      <kind>dataclass</kind>
      <signature><![CDATA[
@dataclass
class RiskControlState:
    kill_switch_active: bool = False
    kill_switch_reason: Optional[str] = None
    kill_switch_triggered_at: Optional[str] = None
    daily_start_equity: Optional[float] = None
    daily_start_date: Optional[str] = None
    daily_loss_pct: float = 0.0
    daily_loss_triggered: bool = False
    
    def to_dict(self) -> Dict[str, Any]: ...
    
    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> "RiskControlState": ...
]]></signature>
      <path>core/risk_control.py</path>
    </interface>
  </interfaces>

  <tests>
    <standards>使用 pytest 框架，测试文件位于 tests/ 目录，命名为 test_*.py。测试类使用 Test* 前缀，测试方法使用 test_* 前缀。使用 tmp_path fixture 处理临时文件。遵循 AAA 模式（Arrange-Act-Assert）。</standards>
    <locations>
      <location>tests/test_risk_control.py</location>
    </locations>
    <ideas>
      <idea ac="AC1,AC2">test_risk_control_state_default_values - 测试默认值初始化</idea>
      <idea ac="AC2">test_risk_control_state_custom_values - 测试自定义值初始化</idea>
      <idea ac="AC3">test_risk_control_state_to_dict - 测试序列化为字典</idea>
      <idea ac="AC3">test_risk_control_state_to_dict_json_serializable - 测试字典可被 json.dumps 处理</idea>
      <idea ac="AC4">test_risk_control_state_from_dict - 测试从完整字典反序列化</idea>
      <idea ac="AC5">test_risk_control_state_from_dict_missing_fields - 测试缺失字段使用默认值</idea>
      <idea ac="AC5">test_risk_control_state_from_dict_empty_dict - 测试空字典反序列化</idea>
      <idea ac="AC3,AC4">test_risk_control_state_roundtrip - 测试序列化/反序列化往返</idea>
    </ideas>
  </tests>
</story-context>
